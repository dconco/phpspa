/**
 * ===========================================================
 *  _____     _             _____  _____
 *  |  __ \  | |           / ____||  __ \  /\    
 *  | |__) | | |__   _ __ | (___  | |__) |/  \   
 *  |  ___/  | '_ \ | '_ \ \___ \ |  ___// /\ \  
 *  | |      | | | || |_) |____) || |   / ____ \ 
 *  |_|      |_| |_|| .__/|_____/ |_|  /_/    \_\
 *                  | |
 *                  |_|
 * 
 * ===========================================================
 * 
 * PhpSPA JavaScript Engine
 *
 * A lightweight JavaScript engine for PHP-powered single-page applications.
 * Handles SPA-style navigation, content replacement, and lifecycle events
 * without full page reloads. Designed to pair with the `PhpSPA` PHP framework.
 *
 * Note:
 * - All scripts and logic must be attached per component using `$component->script(...)`.
 * - This library assumes server-rendered HTML responses with placeholder target IDs.
 *
 * @author Dave Conco <concodave@gmail.com>
 * @link https://github.com/dconco/phpspa-js
 * @version 2.0.0
 * @license MIT
 */
function utf8ToBase64(t){try{return btoa(t)}catch(e){try{const e=(new TextEncoder).encode(t),n=Array.from(e,t=>String.fromCharCode(t)).join("");return btoa(n)}catch(e){return btoa(t.split("").map(function(t){return String.fromCharCode(255&t.charCodeAt(0))}).join(""))}}}function base64ToUtf8(t){try{const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return(new TextDecoder).decode(n)}catch(e){return atob(t)}}window.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("[data-phpspa-target]");if(RuntimeManager.emit("load",{route:location.href,success:!0,error:!1}),t){const e={url:location.href,title:document.title,targetID:t.id,content:t.innerHTML,root:!0};t.hasAttribute("phpspa-reload-time")&&(e.reloadTime=Number(t.getAttribute("phpspa-reload-time"))),RuntimeManager.replaceState(e,document.title,location.href),t.hasAttribute("phpspa-reload-time")&&setTimeout(phpspa.reloadComponent,e.reloadTime)}}),document.addEventListener("click",t=>{const e=t.target.closest('a[data-type="phpspa-link-tag"]');e&&(t.preventDefault(),phpspa.navigate(new URL(e.href,location.href),"push"))}),window.addEventListener("popstate",t=>{const e=t.state;if(RuntimeManager.emit("beforeload",{route:location.href}),history.scrollRestoration="auto",e&&e.content){document.title=e.title??document.title;const t=document.getElementById(e.targetID)??document.body,n=()=>{t.innerHTML=e.content},r=()=>{RuntimeManager.clearExecutedScripts(),RuntimeManager.runAll(e.root?document.body:t),void 0!==e.reloadTime&&setTimeout(phpspa.reloadComponent,e.reloadTime),RuntimeManager.emit("load",{route:location.href,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(n).finished.then(r).catch(t=>{RuntimeManager.emit("load",{route:location.href,message:t,success:!1,error:!0})}):(n(),r())}else phpspa.navigate(new URL(location.href),"replace")});class phpspa{static navigate(t,e="push"){function n(e){e.response?e.response.text().then(n=>{let a;try{a=n.trim().startsWith("{")?JSON.parse(n):n}catch(t){a=n}r(a||""),RuntimeManager.emit("load",{route:t,success:!1,error:e.message||"Server returned an error",data:a})}).catch(()=>{r(""),RuntimeManager.emit("load",{route:t,success:!1,error:e.message||"Failed to read error response"})}):(r(""),RuntimeManager.emit("load",{route:t,success:!1,error:e.message||"No connection to server"}))}function r(n){"string"!=typeof n?.title&&"number"!=typeof n?.title||(document.title=n.title);const r=document.getElementById(n?.targetID)??document.getElementById(history.state?.targetID)??document.body,a=()=>{r.innerHTML=n?.content?n.content:n},o={url:t?.href??t,title:n?.title??document.title,targetID:n?.targetID??r.id,content:n?.content??n};void 0!==n.reloadTime&&(o.reloadTime=n.reloadTime);const s=()=>{"push"===e?RuntimeManager.pushState(o,o.title,t):"replace"===e&&RuntimeManager.replaceState(o,o.title,t);const a=document.getElementById(t?.hash?.substring(1));a?scroll({top:a.offsetTop,left:a.offsetLeft}):scroll(0,0),RuntimeManager.clearExecutedScripts(),RuntimeManager.runAll(r),RuntimeManager.emit("load",{route:t,success:!0,error:!1}),void 0!==n.reloadTime&&setTimeout(phpspa.reloadComponent,n.reloadTime)};document.startViewTransition?document.startViewTransition(a).finished.then(s).catch(t=>{RuntimeManager.emit("load",{route:location.href,message:t,success:!1,error:!0})}):(a(),s())}RuntimeManager.emit("beforeload",{route:t}),fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(t=>{let e;if(t&&t.trim().startsWith("{"))try{e=JSON.parse(t)}catch(n){e=t}else e=t||"";r(e)}).catch(t=>n(t))}).catch(t=>n(t))}static back(){history.back()}static forward(){history.forward()}static reload(){phpspa.navigate(new URL(location.href),"replace")}static on(t,e){RuntimeManager.events[t]||(RuntimeManager.events[t]=[]),RuntimeManager.events[t].push(e)}static setState(t,e){return new Promise((n,r)=>{const a={top:scrollY,left:scrollX},o=new URL(location.href),s=JSON.stringify({state:{key:t,value:e}});function i(t){t.response?t.response.text().then(t=>{let e;try{e=t.trim().startsWith("{")?JSON.parse(t):t}catch(n){e=t}c(e||"")}).catch(()=>{c("")}):c("")}function c(t){"string"!=typeof t?.title&&"number"!=typeof t?.title||(document.title=t.title);const e=document.getElementById(t?.targetID)??document.getElementById(history.state?.targetID)??document.body,n=()=>{e.innerHTML=t?.content?t.content:t},r=()=>{RuntimeManager.clearExecutedScripts(),RuntimeManager.runAll(e),scroll(a)};document.startViewTransition?document.startViewTransition(n).finished.then(r):(n(),r())}fetch(o,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${utf8ToBase64(s)}`},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(t=>{let e;if(t&&t.trim().startsWith("{"))try{e=JSON.parse(t)}catch(n){e=t}else e=t||"";n(),c(e)}).catch(t=>{r(t.message),i(t)})}).catch(t=>{r(t.message),i(t)})})}static reloadComponent(){const t={top:scrollY,left:scrollX};function e(t){t.response?t.response.text().then(t=>{let e;try{e=t.trim().startsWith("{")?JSON.parse(t):t}catch(n){e=t}n(e||"")}).catch(()=>{n("")}):n("")}function n(e){"string"!=typeof e?.title&&"number"!=typeof e?.title||(document.title=e.title);const n=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body,r=()=>{n.innerHTML=e?.content?e.content:e},a=()=>{RuntimeManager.clearExecutedScripts(),RuntimeManager.runAll(n),scroll(t),void 0!==e.reloadTime&&setTimeout(phpspa.reloadComponent,e.reloadTime)};document.startViewTransition?document.startViewTransition(r).finished.then(a):(r(),a())}fetch(new URL(location.href),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(t=>{let e;if(t&&t.trim().startsWith("{"))try{e=JSON.parse(t)}catch(n){e=t}else e=t||"";n(e)}).catch(t=>{e(t)})}).catch(t=>{e(t)})}static async __call(t,...e){const n=new URL(location.href),r=JSON.stringify({__call:{token:t,args:e}});try{const t=await fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${utf8ToBase64(r)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),e=await t.text();let a;if(e&&e.trim().startsWith("{"))try{a=JSON.parse(e),a=a?.response?JSON.parse(a.response):a}catch(t){a=e}else a=e||"";return a}catch(t){if(!t.response)return"";try{const e=await t.response.text();let n;try{n=e.trim().startsWith("{")?JSON.parse(e):e,n=n?.response?JSON.parse(n.response):n}catch(t){n=e}return n}catch{return""}}}}class RuntimeManager{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static events={beforeload:[],load:[]};static runAll(t){this.runInlineScripts(t),this.runInlineStyles(t),this.runPhpSpaScripts(t)}static runInlineScripts(t){const e=t.querySelectorAll("script"),n=document.documentElement.getAttribute("x-phpspa");e.forEach(t=>{const e=utf8ToBase64(t.textContent.trim());if(!this.executedScripts.has(e)&&""!==t.textContent.trim()){this.executedScripts.add(e);const r=document.createElement("script");r.nonce=n;for(const e of t.attributes)r.setAttribute(e.name,e.value);const a=t.hasAttribute("async");r.textContent=a?`(async function() {\n${t.textContent}\n})();`:`(function() {\n${t.textContent}\n})();`,document.head.appendChild(r).remove()}})}static runPhpSpaScripts(t){t.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]').forEach(async t=>{const e=t.getAttribute("src"),n=document.documentElement.getAttribute("x-phpspa");if(!this.executedScripts.has(e)){if(this.executedScripts.add(e),this.ScriptsCachedContent[e]){const t=document.createElement("script");return t.textContent=this.ScriptsCachedContent[e],t.type="text/javascript",t.nonce=n,void document.head.appendChild(t).remove()}const t=await fetch(e,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(t.ok){const r=await t.text(),a=document.createElement("script");a.textContent=r,a.type="text/javascript",a.nonce=n,document.head.appendChild(a).remove(),this.ScriptsCachedContent[e]=r}else console.error(`Failed to load script from ${e}: ${t.statusText}`)}})}static clearExecutedScripts(){RuntimeManager.executedScripts.clear()}static runInlineStyles(t){const e=t.querySelectorAll("style"),n=document.documentElement.getAttribute("x-phpspa");e.forEach(t=>{const e=utf8ToBase64(t.textContent.trim());if(!this.executedStyles.has(e)&&""!==t.textContent.trim()){this.executedStyles.add(e);const r=document.createElement("style");r.nonce=n;for(const e of t.attributes)r.setAttribute(e.name,e.value);r.textContent=t.textContent,document.head.appendChild(r).remove()}})}static emit(t,e){const n=this.events[t]||[];for(const r of n)if("function"==typeof r)try{r(e)}catch(e){console.error(`Error in ${t} event callback:`,e)}}static pushState(...t){try{history.pushState(...t)}catch(t){console.warn("Failed to push history state:",t.message)}}static replaceState(...t){try{history.replaceState(...t)}catch(t){console.warn("Failed to replace history state:",t.message)}}}if("function"!=typeof setState)function setState(t,e){return phpspa.setState(t,e)}if("function"!=typeof __call)function __call(t,...e){return phpspa.__call(t,...e)}void 0===window.phpspa&&(window.phpspa=phpspa);