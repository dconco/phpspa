/*!
 * PhpSPA Client Runtime v2.0.8
 * Docs: https://phpspa.tech | Package: @dconco/phpspa
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).phpspa={})}(this,function(t){"use strict";function e(t){try{return btoa(t)}catch(e){try{const e=(new TextEncoder).encode(t),n=Array.from(e,t=>String.fromCharCode(t)).join("");return btoa(n)}catch(e){return btoa(t.split("").map(function(t){return String.fromCharCode(255&t.charCodeAt(0))}).join(""))}}}class n{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static currentStateData;static lastEventPayload={};static effects=new Set;static memoizedCallbacks=[];static registerEffect(t,e=null){const r=t(),a={callback:t,dependencies:e,cleanup:"function"==typeof r?r:null};n.effects.add(a)}static triggerEffects(t,e){n.effects.forEach(e=>{if(!e.dependencies||e.dependencies.includes(t)){e.cleanup&&e.cleanup();const t=e.callback();e.cleanup="function"==typeof t?t:null}})}static clearEffects(){n.effects.forEach(t=>{t.cleanup&&t.cleanup()}),n.effects.clear()}static depsEqual(t,e){return t.length===e.length&&t.every((t,n)=>Object.is(t,e[n]))}static registerCallback(t,e=[]){const r=n.memoizedCallbacks.find(t=>n.depsEqual(t.deps,e));if(r)return r.callback;const a=t.bind(void 0);return n.memoizedCallbacks.push({deps:e.slice(),callback:a}),a}static runAll(){for(const t in n.currentRoutes){const e=document.getElementById(t);e&&(this.runInlineScripts(e),this.runPhpSpaScripts(e),this.runInlineStyles(e))}}static runInlineScripts(t){const n=t.querySelectorAll("script"),r=document.head.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedScripts.has(n)&&""!==t.textContent.trim()){this.executedScripts.add(n);const e=document.createElement("script");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);const a=t.hasAttribute("async");e.textContent=a?`(async function() {\n${t.textContent}\n})()`:`(function() {\n${t.textContent}\n})()`,document.head.appendChild(e).remove()}})}static runPhpSpaScripts(t){const e=t.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]'),n=document.head.getAttribute("x-phpspa");e.forEach(async t=>{const e=t.getAttribute("src")??"",r=t.getAttribute("type")??"";if(!this.executedScripts.has(e)){if(this.executedScripts.add(e),this.ScriptsCachedContent[e]){const t=document.createElement("script");return t.textContent=this.ScriptsCachedContent[e],t.nonce=n??void 0,t.type=r,void document.head.appendChild(t).remove()}const t=await fetch(e,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(t.ok){const a=await t.text(),o=document.createElement("script");o.textContent=a,o.nonce=n??void 0,o.type=r,document.head.appendChild(o).remove(),this.ScriptsCachedContent[e]=a}else console.error(`Failed to load script from ${e}: ${t.statusText}`)}})}static clearExecutedScripts(){n.executedScripts.clear()}static runInlineStyles(t){const n=t.querySelectorAll("style"),r=document.head.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedStyles.has(n)&&""!==t.textContent.trim()){this.executedStyles.add(n);const e=document.createElement("style");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);e.textContent=t.textContent,document.head.appendChild(e).remove()}})}static emit(t,e){const n=this.events[t]||[];this.lastEventPayload[t]=e;for(const r of n)if("function"==typeof r)try{r(e)}catch(e){console.error(`Error in ${t} event callback:`,e)}}static getLastEventPayload(t){return this.lastEventPayload[t]}static pushState(t,e,n){try{history.pushState(t,e,n)}catch(t){console.warn("Failed to push history state:",t instanceof Error?t.message:t)}}static replaceState(t,e,n){try{history.replaceState(t,e,n)}catch(t){console.warn("Failed to replace history state:",t instanceof Error?t.message:t)}}}var r;var a="undefined"==typeof document?void 0:document,o=!!a&&"content"in a.createElement("template"),i=!!a&&a.createRange&&"createContextualFragment"in a.createRange();function c(t){return t=t.trim(),o?function(t){var e=a.createElement("template");return e.innerHTML=t,e.content.childNodes[0]}(t):i?function(t){return r||(r=a.createRange()).selectNode(a.body),r.createContextualFragment(t).childNodes[0]}(t):function(t){var e=a.createElement("body");return e.innerHTML=t,e.childNodes[0]}(t)}function s(t,e){var n,r,a=t.nodeName,o=e.nodeName;return a===o||(n=a.charCodeAt(0),r=o.charCodeAt(0),n<=90&&r>=97?a===o.toUpperCase():r<=90&&n>=97&&o===a.toUpperCase())}function l(t,e,n){t[n]!==e[n]&&(t[n]=e[n],t[n]?t.setAttribute(n,""):t.removeAttribute(n))}var d={OPTION:function(t,e){var n=t.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(t.hasAttribute("selected")&&!e.selected&&(t.setAttribute("selected","selected"),t.removeAttribute("selected")),n.selectedIndex=-1)}l(t,e,"selected")},INPUT:function(t,e){l(t,e,"checked"),l(t,e,"disabled"),t.value!==e.value&&(t.value=e.value),e.hasAttribute("value")||t.removeAttribute("value")},TEXTAREA:function(t,e){var n=e.value;t.value!==n&&(t.value=n);var r=t.firstChild;if(r){var a=r.nodeValue;if(a==n||!n&&a==t.placeholder)return;r.nodeValue=n}},SELECT:function(t,e){if(!e.hasAttribute("multiple")){for(var n,r,a=-1,o=0,i=t.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){a=o;break}o++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}t.selectedIndex=a}}};function u(){}function f(t){if(t)return t.getAttribute&&t.getAttribute("id")||t.id}var h=function(t){return function(e,n,r){if(r||(r={}),"string"==typeof n)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var o=n;(n=a.createElement("html")).innerHTML=o}else n=c(n);else 11===n.nodeType&&(n=n.firstElementChild);var i=r.getNodeKey||f,l=r.onBeforeNodeAdded||u,h=r.onNodeAdded||u,p=r.onBeforeElUpdated||u,m=r.onElUpdated||u,g=r.onBeforeNodeDiscarded||u,y=r.onNodeDiscarded||u,S=r.onBeforeElChildrenUpdated||u,v=r.skipFromChildren||u,b=r.addChild||function(t,e){return t.appendChild(e)},C=!0===r.childrenOnly,E=Object.create(null),x=[];function T(t){x.push(t)}function w(t,e){if(1===t.nodeType)for(var n=t.firstChild;n;){var r=void 0;e&&(r=i(n))?T(r):(y(n),n.firstChild&&w(n,e)),n=n.nextSibling}}function A(t,e,n){!1!==g(t)&&(e&&e.removeChild(t),y(t),w(t,n))}function N(t){if(1===t.nodeType||11===t.nodeType)for(var e=t.firstChild;e;){var n=i(e);n&&(E[n]=e),N(e),e=e.nextSibling}}function I(t){h(t);for(var e=t.firstChild;e;){var n=e.nextSibling,r=i(e);if(r){var a=E[r];a&&s(e,a)?(e.parentNode.replaceChild(a,e),D(a,e)):I(e)}else I(e);e=n}}function D(e,n,r){var o=i(n);if(o&&delete E[o],!r){var c=p(e,n);if(!1===c)return;if(c instanceof HTMLElement&&N(e=c),t(e,n),m(e),!1===S(e,n))return}"TEXTAREA"!==e.nodeName?function(t,e){var n,r,o,c,u,f=v(t,e),h=e.firstChild,p=t.firstChild;t:for(;h;){for(c=h.nextSibling,n=i(h);!f&&p;){if(o=p.nextSibling,h.isSameNode&&h.isSameNode(p)){h=c,p=o;continue t}r=i(p);var m=p.nodeType,g=void 0;if(m===h.nodeType&&(1===m?(n?n!==r&&((u=E[n])?o===u?g=!1:(t.insertBefore(u,p),r?T(r):A(p,t,!0),r=i(p=u)):g=!1):r&&(g=!1),(g=!1!==g&&s(p,h))&&D(p,h)):3!==m&&8!=m||(g=!0,p.nodeValue!==h.nodeValue&&(p.nodeValue=h.nodeValue))),g){h=c,p=o;continue t}r?T(r):A(p,t,!0),p=o}if(n&&(u=E[n])&&s(u,h))f||b(t,u),D(u,h);else{var y=l(h);!1!==y&&(y&&(h=y),h.actualize&&(h=h.actualize(t.ownerDocument||a)),b(t,h),I(h))}h=c,p=o}!function(t,e,n){for(;e;){var r=e.nextSibling;(n=i(e))?T(n):A(e,t,!0),e=r}}(t,p,r);var S=d[t.nodeName];S&&S(t,e)}(e,n):d.TEXTAREA(e,n)}N(e);var O,R,P=e,k=P.nodeType,L=n.nodeType;if(!C)if(1===k)1===L?s(e,n)||(y(e),P=function(t,e){for(var n=t.firstChild;n;){var r=n.nextSibling;e.appendChild(n),n=r}return e}(e,(O=n.nodeName,(R=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==R?a.createElementNS(R,O):a.createElement(O)))):P=n;else if(3===k||8===k){if(L===k)return P.nodeValue!==n.nodeValue&&(P.nodeValue=n.nodeValue),P;P=n}if(P===n)y(e);else{if(n.isSameNode&&n.isSameNode(P))return;if(D(P,n,C),x)for(var U=0,_=x.length;U<_;U++){var B=E[x[U]];B&&A(B,B.parentNode,!1)}}return!C&&P!==e&&e.parentNode&&(P.actualize&&(P=P.actualize(e.ownerDocument||a)),e.parentNode.replaceChild(P,e)),P}}(function(t,e){var n,r,a,o,i=e.attributes;if(11!==e.nodeType&&11!==t.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,a=n.namespaceURI,o=n.value,a?(r=n.localName||r,t.getAttributeNS(a,r)!==o&&("xmlns"===n.prefix&&(r=n.name),t.setAttributeNS(a,r,o))):t.getAttribute(r)!==o&&t.setAttribute(r,o);for(var s=t.attributes,l=s.length-1;l>=0;l--)r=(n=s[l]).name,(a=n.namespaceURI)?(r=n.localName||r,e.hasAttributeNS(a,r)||t.removeAttributeNS(a,r)):e.hasAttribute(r)||t.removeAttribute(r)}});class p{static currentStateData={};static navigate(t,e="push"){const r=t instanceof URL?t:new URL(t,location.toString());function a(t){t.response?t.response.text().then(e=>{let a;try{a=e?.trim().startsWith("{")?JSON.parse(e):e}catch(t){a=e}o(a||""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"Server returned an error",data:a})}).catch(()=>{o(""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"Failed to read error response"})}):(o(""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"No connection to server"}))}function o(t){const a="string"==typeof t?{content:t,stateData:{}}:t;n.currentStateData=a.stateData,a?.title&&a.title.length>0&&(document.title=a.title);const o=document.getElementById(a?.targetID)??document.getElementById(history.state?.targetID)??document.body;a?.targetID&&(n.currentRoutes[a.targetID]={route:r,exact:a.exact??!1,defaultContent:n.currentRoutes[a.targetID]?.defaultContent??o.innerHTML});const i=n.currentRoutes;for(const t in i){if(!Object.hasOwn(i,t))continue;const e=i[t];if(!0===e.exact&&t!==a?.targetID){let n=document.getElementById(t);if(n)try{h(n,"<div>"+e.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=e.defaultContent}delete i[t]}}const c=()=>{try{h(o,"<div>"+a.content+"</div>",{childrenOnly:!0})}catch{o.innerHTML=a.content}},s={url:r.toString(),title:a?.title??document.title,targetID:o.id,content:a.content,exact:i[a?.targetID]?.exact,defaultContent:i[a?.targetID]?.defaultContent};a?.reloadTime&&(s.reloadTime=a.reloadTime);const l=()=>{"push"===e?n.pushState(s,s.title,r):"replace"===e&&n.replaceState(s,s.title,r);const t=document.getElementById(r.hash.substring(1));t?scroll({top:t.offsetTop,left:t.offsetLeft}):scroll(0,0),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),n.emit("load",{route:r.toString(),success:!0,error:!1}),a?.reloadTime&&setTimeout(p.reloadComponent,a.reloadTime)};document.startViewTransition?document.startViewTransition(c).finished.then(l).catch(t=>{n.emit("load",{route:r.toString(),success:!1,error:t||"Unknown error during view transition"})}):(c(),l())}n.emit("beforeload",{route:r.toString()}),fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(t=>{let e;if(t&&t.trim().startsWith("{"))try{e=JSON.parse(t)}catch(n){e=t}else e=t||"";o(e)}).catch(t=>a(t))}).catch(t=>a(t))}static back(){history.back()}static forward(){history.forward()}static reload(){p.navigate(location.toString(),"replace")}static on(t,e){n.events[t]||(n.events[t]=[]),n.events[t].push(e);const r=n.getLastEventPayload(t);if(r)try{e(r)}catch(e){console.error(`Error in ${t} event callback:`,e)}}static useEffect(t,e=null){n.registerEffect(t,e)}static useCallback(t,e=[]){return n.registerCallback(t,e)}static setState(t,r){return"function"==typeof r&&(r=r(n.currentStateData[t])),new Promise(async(a,o)=>{const i=n.currentRoutes,c=JSON.stringify({state:{key:t,value:r}}),s=[];for(const t in i){if(!Object.hasOwn(i,t))continue;const{route:n}=i[t],r=fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0});s.push(r)}function l(e){const a="string"==typeof e?{content:e,stateData:{}}:e;n.currentStateData=a.stateData,a?.title&&String(a.title).length>0&&(document.title=a.title);const o=document.getElementById(a?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{h(o,"<div>"+a.content+"</div>",{childrenOnly:!0})}catch{o.innerHTML=a.content}})(),n.triggerEffects(t,r)}(await Promise.all(s)).forEach(async t=>{try{const e=await t.text();let n;if(e&&e.trim().startsWith("{"))try{n=JSON.parse(e)}catch(t){n=e}else n=e||"";a(),l(n)}catch(t){o(t),function(t){t?.response?t.response.text().then(t=>{let e;try{e=t?.trim().startsWith("{")?JSON.parse(t):t}catch(n){e=t}l(e||"")}).catch(()=>{l("")}):l("")}(t)}})})}static reloadComponent(){function t(t){t?.response?t.response.text().then(t=>{let n;try{n=t?.trim().startsWith("{")?JSON.parse(t):t}catch(e){n=t}e(n||"")}).catch(()=>{e("")}):e("")}function e(t){const e="string"==typeof t?{content:t,stateData:{}}:t;n.currentStateData=e.stateData,e?.title&&String(e.title).length>0&&(document.title=e.title);const r=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{h(r,"<div>"+e.content+"</div>",{childrenOnly:!0})}catch{r.innerHTML=e.content}})(),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),e?.reloadTime&&setTimeout(p.reloadComponent,e.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(n=>{n.text().then(t=>{let n;if(t&&t.trim().startsWith("{"))try{n=JSON.parse(t)}catch(e){n=t}else n=t||"";e(n)}).catch(e=>{t(e)})}).catch(e=>{t(e)})}static async __call(t,...n){const r=JSON.stringify({__call:{token:t,args:n}});try{const t=await fetch(location.pathname,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(r)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await t.text();let a;if(n&&n.trim().startsWith("{"))try{a=JSON.parse(n),a=a?.response?JSON.parse(a.response):a}catch(t){a=n}else a=n||"";return a}catch(t){if(!t?.response)return"";try{const e=await t.response.text();let n;try{n=e?.trim().startsWith("{")?JSON.parse(e):e,n=n?.response?JSON.parse(n.response):n}catch(t){n=e}return n}catch{return""}}}}function m(){const t=document.querySelector("[data-phpspa-target]"),e=document.querySelector("[phpspa-target-data]"),r=location.toString();if(n.emit("load",{route:r,success:!0,error:!1}),t){const a={url:r,title:document.title,targetID:t.id,content:t.innerHTML,root:!0};if(e){const o=e.getAttribute("phpspa-target-data"),i=JSON.parse(function(t){try{const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return(new TextDecoder).decode(n)}catch(e){return atob(t)}}(o??""));i.reloadTime&&(a.reloadTime=i.reloadTime),n.currentStateData=i.stateData,i.targetIDs.forEach((e,o)=>{const c=i.exact[o],s=i.defaultContent[o];e===t.id&&(a.exact=c,a.defaultContent=s),n.currentRoutes[e]={route:new URL(i.currentRoutes[o],r),defaultContent:s,exact:c}})}n.replaceState(a,document.title,r),a.reloadTime&&setTimeout(p.reloadComponent,a.reloadTime)}document.addEventListener("click",t=>{if(t.defaultPrevented||0!==t.button)return;if(t.metaKey||t.ctrlKey||t.shiftKey||t.altKey)return;const e=t.target?.closest?.('a[data-type="phpspa-link-tag"]');if(!e)return;if(e.hasAttribute("download"))return;if(e.getAttribute("target")&&"_self"!==e.getAttribute("target"))return;const n=e.getAttribute("href");if(!n)return;const r=new URL(n,location.toString());r.origin===location.origin&&(t.preventDefault(),p.navigate(r,"push"))})}class g extends p{}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",m,{once:!0}):["interactive","complete"].includes(document.readyState)&&m(),window.addEventListener("popstate",t=>{const e=t.state;if(n.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",e&&e.content){document.title=e.title??document.title;const t=document.getElementById(e.targetID);if(!t)return void location.reload();e.targetID&&(n.currentRoutes[e.targetID]={route:new URL(e.url),exact:e.exact??!1,defaultContent:e.defaultContent||""});const r=n.currentRoutes;for(const t in r){if(!Object.hasOwn(r,t))continue;const n=r[t];if(!0===n.exact&&t!==e.targetID){let e=document.getElementById(t);if(e)try{h(e,"<div>"+n.defaultContent+"</div>",{childrenOnly:!0})}catch{e.innerHTML=n.defaultContent}delete r[t]}}const a=()=>{try{h(t,"<div>"+e.content+"</div>",{childrenOnly:!0})}catch{t.innerHTML=e.content}},o=()=>{n.clearEffects(),n.clearExecutedScripts(),n.runAll(),e?.reloadTime&&setTimeout(p.reloadComponent,e.reloadTime),n.emit("load",{route:e.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(a).finished.then(o).catch(t=>{n.emit("load",{route:location.href,success:!1,error:t||"Unknown error during view transition"})}):(a(),o())}else location.reload()}),"undefined"!=typeof window&&(window.phpspa=g,window.setState!==g.setState&&(window.setState=g.setState),window.__call!==g.__call&&(window.__call=g.__call),window.useEffect!==g.useEffect&&(window.useEffect=g.useEffect),window.useCallback!==g.useCallback&&(window.useCallback=g.useCallback));const y=g.setState.bind(g),S=g.useEffect.bind(g),v=g.useCallback.bind(g),b=g.__call.bind(g);t.__call=b,t.default=g,t.setState=y,t.useCallback=v,t.useEffect=S,Object.defineProperty(t,"__esModule",{value:!0})});
