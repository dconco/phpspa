/*!
 * PhpSPA Client Runtime v2.0.10
 * Docs: https://phpspa.tech | Package: @dconco/phpspa
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).phpspa={})}(this,function(e){"use strict";const t=()=>new Promise(e=>{requestAnimationFrame(()=>requestAnimationFrame(()=>e()))}),n=e=>new Promise(n=>{if(e.sheet)return void t().then(n);const r=()=>(e.removeEventListener("load",r),e.removeEventListener("error",r),void n());e.addEventListener("load",r,{once:!0}),e.addEventListener("error",r,{once:!0})}),r=async e=>{const r=document.createElement("div");r.innerHTML=e;const a=Array.from(r.querySelectorAll('link[rel="stylesheet"]'));if(0===a.length)return r;const o=Array.from(document.head.querySelectorAll('link[rel="stylesheet"]')),i=a.map(e=>{const t=e.getAttribute("href");if(e.remove(),!t)return Promise.resolve();let r="";try{r=new URL(t,location.toString()).href}catch{r=t}let a=o.find(e=>{try{return e.href===r}catch{return e.getAttribute("href")===t}});return a||(a=e.cloneNode(!0),document.head.appendChild(a),o.push(a)),n(a)});return await Promise.all(i),await t(),r};function a(e){try{return btoa(e)}catch(t){try{const t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}catch(t){return btoa(e.split("").map(function(e){return String.fromCharCode(255&e.charCodeAt(0))}).join(""))}}}class o{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static currentStateData;static lastEventPayload={};static effects=new Set;static memoizedCallbacks=[];static registerEffect(e,t=null){const n=e(),r={callback:e,dependencies:t,cleanup:"function"==typeof n?n:null,lastDeps:t?o.resolveDependencies(t):null};o.effects.add(r)}static triggerEffects(e,t){o.effects.forEach(e=>{if(!e.dependencies||0===e.dependencies.length)return void o.invokeEffect(e,e.dependencies);const t=o.resolveDependencies(e.dependencies);e.lastDeps&&o.depsEqual(e.lastDeps,t)||o.invokeEffect(e,t)})}static clearEffects(){o.effects.forEach(e=>{e.cleanup&&e.cleanup()}),o.effects.clear()}static depsEqual(e,t){return e===t||!(!e||!t)&&(e.length===t.length&&e.every((e,n)=>Object.is(e,t[n])))}static registerCallback(e,t=[]){const n=o.resolveDependencies(t),r=o.memoizedCallbacks.find(e=>e.deps.length===t.length&&o.depsEqual(e.resolvedDeps,n));if(r)return r.callback;const a=e.bind(void 0);return o.memoizedCallbacks.push({deps:t.slice(),resolvedDeps:n,callback:a}),a}static resolveDependencies(e){return e.map(e=>o.resolveDependency(e))}static resolveDependency(e){return"string"==typeof e&&o.currentStateData&&Object.prototype.hasOwnProperty.call(o.currentStateData,e)?o.currentStateData[e]:e}static invokeEffect(e,t){e.cleanup&&e.cleanup();const n=e.callback();e.cleanup="function"==typeof n?n:null,e.lastDeps=t?t.slice():t}static runScripts(){for(const e in o.currentRoutes){const t=document.getElementById(e);t&&(this.runInlineScripts(t),this.runPhpSpaScripts(t))}}static runStyles(){for(const e in o.currentRoutes){const t=document.getElementById(e);t&&this.runInlineStyles(t)}}static runInlineScripts(e){const t=e.querySelectorAll("script"),n=document.head.getAttribute("x-phpspa");t.forEach(e=>{const t=a(e.textContent.trim());if(!this.executedScripts.has(t)&&""!==e.textContent.trim()){this.executedScripts.add(t);const r=document.createElement("script");r.nonce=n??void 0;for(const t of Array.from(e.attributes))r.setAttribute(t.name,t.value);r.textContent=`(()=>{\n${e.textContent}\n})()`,document.head.appendChild(r).remove()}})}static runPhpSpaScripts(e){const t=e.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]'),n=document.head.getAttribute("x-phpspa");t.forEach(async e=>{const t=e.getAttribute("src")??"",r=e.getAttribute("type")??"";if(!this.executedScripts.has(t)){if(this.executedScripts.add(t),this.ScriptsCachedContent[t]){const e=document.createElement("script");return e.textContent=`(()=>{\n${this.ScriptsCachedContent[t]}\n})()`,e.nonce=n??void 0,e.type=r,void document.head.appendChild(e).remove()}const e=await fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(e.ok){const a=await e.text(),o=document.createElement("script");o.textContent=`(()=>{\n${a}\n})()`,o.nonce=n??void 0,o.type=r,document.head.appendChild(o).remove(),this.ScriptsCachedContent[t]=a}else console.error(`Failed to load script from ${t}: ${e.statusText}`)}})}static clearExecutedScripts(){o.executedScripts.clear()}static runInlineStyles(e){const t=e.querySelectorAll("style"),n=document.head.getAttribute("x-phpspa");t.forEach(e=>{const t=a(e.textContent.trim());if(!this.executedStyles.has(t)&&""!==e.textContent.trim()){this.executedStyles.add(t);const r=document.createElement("style");r.nonce=n??void 0;for(const t of Array.from(e.attributes))r.setAttribute(t.name,t.value);r.textContent=e.textContent,document.head.appendChild(r).remove()}})}static emit(e,t){const n=this.events[e]||[];this.lastEventPayload[e]=t;for(const r of n)if("function"==typeof r)try{r(t)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static getLastEventPayload(e){return this.lastEventPayload[e]}static pushState(e,t,n){try{history.pushState(e,t,n)}catch(e){console.warn("Failed to push history state:",e instanceof Error?e.message:e)}}static replaceState(e,t,n){try{history.replaceState(e,t,n)}catch(e){console.warn("Failed to replace history state:",e instanceof Error?e.message:e)}}}var i;var c="undefined"==typeof document?void 0:document,s=!!c&&"content"in c.createElement("template"),l=!!c&&c.createRange&&"createContextualFragment"in c.createRange();function d(e){return e=e.trim(),s?function(e){var t=c.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):l?function(e){return i||(i=c.createRange()).selectNode(c.body),i.createContextualFragment(e).childNodes[0]}(e):function(e){var t=c.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function u(e,t){var n,r,a=e.nodeName,o=t.nodeName;return a===o||(n=a.charCodeAt(0),r=o.charCodeAt(0),n<=90&&r>=97?a===o.toUpperCase():r<=90&&n>=97&&o===a.toUpperCase())}function f(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var p={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}f(e,t,"selected")},INPUT:function(e,t){f(e,t,"checked"),f(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var a=r.nodeValue;if(a==n||!n&&a==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,a=-1,o=0,i=e.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){a=o;break}o++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}e.selectedIndex=a}}};function h(){}function m(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var y=function(e){return function(t,n,r){if(r||(r={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var a=n;(n=c.createElement("html")).innerHTML=a}else n=d(n);else 11===n.nodeType&&(n=n.firstElementChild);var o=r.getNodeKey||m,i=r.onBeforeNodeAdded||h,s=r.onNodeAdded||h,l=r.onBeforeElUpdated||h,f=r.onElUpdated||h,y=r.onBeforeNodeDiscarded||h,g=r.onNodeDiscarded||h,S=r.onBeforeElChildrenUpdated||h,v=r.skipFromChildren||h,b=r.addChild||function(e,t){return e.appendChild(t)},E=!0===r.childrenOnly,C=Object.create(null),w=[];function T(e){w.push(e)}function x(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=o(n))?T(r):(g(n),n.firstChild&&x(n,t)),n=n.nextSibling}}function A(e,t,n){!1!==y(e)&&(t&&t.removeChild(e),g(e),x(e,n))}function D(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=o(t);n&&(C[n]=t),D(t),t=t.nextSibling}}function N(e){s(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=o(t);if(r){var a=C[r];a&&u(t,a)?(t.parentNode.replaceChild(a,t),I(a,t)):N(t)}else N(t);t=n}}function I(t,n,r){var a=o(n);if(a&&delete C[a],!r){var s=l(t,n);if(!1===s)return;if(s instanceof HTMLElement&&D(t=s),e(t,n),f(t),!1===S(t,n))return}"TEXTAREA"!==t.nodeName?function(e,t){var n,r,a,s,l,d=v(e,t),f=t.firstChild,h=e.firstChild;e:for(;f;){for(s=f.nextSibling,n=o(f);!d&&h;){if(a=h.nextSibling,f.isSameNode&&f.isSameNode(h)){f=s,h=a;continue e}r=o(h);var m=h.nodeType,y=void 0;if(m===f.nodeType&&(1===m?(n?n!==r&&((l=C[n])?a===l?y=!1:(e.insertBefore(l,h),r?T(r):A(h,e,!0),r=o(h=l)):y=!1):r&&(y=!1),(y=!1!==y&&u(h,f))&&I(h,f)):3!==m&&8!=m||(y=!0,h.nodeValue!==f.nodeValue&&(h.nodeValue=f.nodeValue))),y){f=s,h=a;continue e}r?T(r):A(h,e,!0),h=a}if(n&&(l=C[n])&&u(l,f))d||b(e,l),I(l,f);else{var g=i(f);!1!==g&&(g&&(f=g),f.actualize&&(f=f.actualize(e.ownerDocument||c)),b(e,f),N(f))}f=s,h=a}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=o(t))?T(n):A(t,e,!0),t=r}}(e,h,r);var S=p[e.nodeName];S&&S(e,t)}(t,n):p.TEXTAREA(t,n)}D(t);var O,P,R=t,k=R.nodeType,L=n.nodeType;if(!E)if(1===k)1===L?u(t,n)||(g(t),R=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(t,(O=n.nodeName,(P=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==P?c.createElementNS(P,O):c.createElement(O)))):R=n;else if(3===k||8===k){if(L===k)return R.nodeValue!==n.nodeValue&&(R.nodeValue=n.nodeValue),R;R=n}if(R===n)g(t);else{if(n.isSameNode&&n.isSameNode(R))return;if(I(R,n,E),w)for(var U=0,_=w.length;U<_;U++){var H=C[w[U]];H&&A(H,H.parentNode,!1)}}return!E&&R!==t&&t.parentNode&&(R.actualize&&(R=R.actualize(t.ownerDocument||c)),t.parentNode.replaceChild(R,t)),R}}(function(e,t){var n,r,a,o,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,a=n.namespaceURI,o=n.value,a?(r=n.localName||r,e.getAttributeNS(a,r)!==o&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(a,r,o))):e.getAttribute(r)!==o&&e.setAttribute(r,o);for(var s=e.attributes,l=s.length-1;l>=0;l--)r=(n=s[l]).name,(a=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(a,r)||e.removeAttributeNS(a,r)):t.hasAttribute(r)||e.removeAttribute(r)}});class g{static currentStateData={};static navigate(e,t="push"){const n=e instanceof URL?e:new URL(e,location.toString());function a(e){e.response?e.response.text().then(t=>{let r;try{r=t?.trim().startsWith("{")?JSON.parse(t):t}catch(e){r=t}i(r||""),o.emit("load",{route:n.toString(),success:!1,error:e.message||"Server returned an error",data:r})}).catch(()=>{i(""),o.emit("load",{route:n.toString(),success:!1,error:e.message||"Failed to read error response"})}):(i(""),o.emit("load",{route:n.toString(),success:!1,error:e.message||"No connection to server"}))}function i(e){const a="string"==typeof e?{content:e,stateData:{}}:e;o.currentStateData=a.stateData,a?.title&&a.title.length>0&&(document.title=a.title);const i=document.getElementById(a?.targetID)??document.getElementById(history.state?.targetID)??document.body;a?.targetID&&(o.currentRoutes[a.targetID]={route:n,exact:a.exact??!1,defaultContent:o.currentRoutes[a.targetID]?.defaultContent??i.innerHTML});const c=o.currentRoutes;for(const e in c){if(!Object.hasOwn(c,e))continue;const t=c[e];if(!0===t.exact&&e!==a?.targetID){let n=document.getElementById(e);if(n)try{y(n,"<div>"+t.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t.defaultContent}delete c[e]}}let s=null;const l=async()=>{if(s=await r(a.content),s)try{y(i,s,{childrenOnly:!0})}catch{i.innerHTML=s.innerHTML}o.runStyles()},d={url:n.toString(),title:a?.title??document.title,targetID:i.id,content:a.content,exact:c[a?.targetID]?.exact,defaultContent:c[a?.targetID]?.defaultContent};a?.reloadTime&&(d.reloadTime=a.reloadTime);const u=async()=>{"push"===t?o.pushState(d,d.title,n):"replace"===t&&o.replaceState(d,d.title,n),o.clearEffects(),o.clearExecutedScripts(),o.runScripts();const e=document.getElementById(n.hash.substring(1));e?scroll({top:e.offsetTop,left:e.offsetLeft}):scroll(0,0),o.emit("load",{route:n.toString(),success:!0,error:!1}),a?.reloadTime&&setTimeout(g.reloadComponent,a.reloadTime)};document.startViewTransition?document.startViewTransition(l).finished.then(u).catch(e=>{o.emit("load",{route:n.toString(),success:!1,error:e||"Unknown error during view transition"})}):(l(),u())}o.emit("beforeload",{route:n.toString()}),fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";i(t)}).catch(e=>a(e))}).catch(e=>a(e))}static back(){history.back()}static forward(){history.forward()}static reload(){g.navigate(location.toString(),"replace")}static on(e,t){o.events[e]||(o.events[e]=[]),o.events[e].push(t);const n=o.getLastEventPayload(e);if(n)try{t(n)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static useEffect(e,t=null){o.registerEffect(e,t)}static useCallback(e,t=[]){return o.registerCallback(e,t)}static setState(e,t){return"function"==typeof t&&(t=t(o.currentStateData[e])),new Promise(async(n,r)=>{const i=o.currentRoutes,c=JSON.stringify({state:{key:e,value:t}}),s=[];for(const e in i){if(!Object.hasOwn(i,e))continue;const{route:t}=i[e],n=fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${a(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0});s.push(n)}function l(n){const r="string"==typeof n?{content:n,stateData:{}}:n;o.currentStateData=r.stateData,r?.title&&String(r.title).length>0&&(document.title=r.title);const a=document.getElementById(r?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{y(a,"<div>"+r.content+"</div>",{childrenOnly:!0})}catch{a.innerHTML=r.content}})(),o.triggerEffects(e,t)}(await Promise.all(s)).forEach(async e=>{try{const t=await e.text();let r;if(t&&t.trim().startsWith("{"))try{r=JSON.parse(t)}catch(e){r=t}else r=t||"";n(),l(r)}catch(e){r(e),function(e){e?.response?e.response.text().then(e=>{let t;try{t=e?.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}l(t||"")}).catch(()=>{l("")}):l("")}(e)}})})}static reloadComponent(){function e(e){e?.response?e.response.text().then(e=>{let n;try{n=e?.trim().startsWith("{")?JSON.parse(e):e}catch(t){n=e}t(n||"")}).catch(()=>{t("")}):t("")}function t(e){const t="string"==typeof e?{content:e,stateData:{}}:e;o.currentStateData=t.stateData,t?.title&&String(t.title).length>0&&(document.title=t.title);const n=document.getElementById(t?.targetID)??document.getElementById(history.state?.targetID)??document.body;(async()=>{const e=await r(t.content);try{y(n,e,{childrenOnly:!0})}catch{n.innerHTML=e.innerHTML}o.runStyles()})(),o.clearEffects(),o.clearExecutedScripts(),o.runScripts(),t?.reloadTime&&setTimeout(g.reloadComponent,t.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(n=>{n.text().then(e=>{let n;if(e&&e.trim().startsWith("{"))try{n=JSON.parse(e)}catch(t){n=e}else n=e||"";t(n)}).catch(t=>{e(t)})}).catch(t=>{e(t)})}static async __call(e,...t){const n=JSON.stringify({__call:{token:e,args:t}});try{const e=await fetch(location.pathname,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${a(n)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),t=await e.text();let r;if(t&&t.trim().startsWith("{"))try{r=JSON.parse(t),r=r?.response?JSON.parse(r.response):r}catch(e){r=t}else r=t||"";return r}catch(e){if(!e?.response)return"";try{const t=await e.response.text();let n;try{n=t?.trim().startsWith("{")?JSON.parse(t):t,n=n?.response?JSON.parse(n.response):n}catch(e){n=t}return n}catch{return""}}}}function S(){const e=document.querySelector("[data-phpspa-target]"),t=document.querySelector("[phpspa-target-data]"),n=location.toString();if(o.emit("load",{route:n,success:!0,error:!1}),e){const r={url:n,title:document.title,targetID:e.id,content:e.innerHTML,root:!0};if(t){const a=t.getAttribute("phpspa-target-data"),i=JSON.parse(function(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return(new TextDecoder).decode(n)}catch(t){return atob(e)}}(a??""));i.reloadTime&&(r.reloadTime=i.reloadTime),o.currentStateData=i.stateData,i.targetIDs.forEach((t,a)=>{const c=i.exact[a],s=i.defaultContent[a];t===e.id&&(r.exact=c,r.defaultContent=s),o.currentRoutes[t]={route:new URL(i.currentRoutes[a],n),defaultContent:s,exact:c}})}o.replaceState(r,document.title,n),r.reloadTime&&setTimeout(g.reloadComponent,r.reloadTime)}document.addEventListener("click",e=>{if(e.defaultPrevented||0!==e.button)return;if(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)return;const t=e.target?.closest?.('a[data-type="phpspa-link-tag"]');if(!t)return;if(t.hasAttribute("download"))return;if(t.getAttribute("target")&&"_self"!==t.getAttribute("target"))return;const n=t.getAttribute("href");if(!n)return;const r=new URL(n,location.toString());r.origin===location.origin&&(e.preventDefault(),g.navigate(r,"push"))})}class v extends g{}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",S,{once:!0}):["interactive","complete"].includes(document.readyState)&&S(),window.addEventListener("popstate",e=>{const t=e.state;if(o.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",t&&t.content){document.title=t.title??document.title;const e=document.getElementById(t.targetID);if(!e)return void location.reload();t.targetID&&(o.currentRoutes[t.targetID]={route:new URL(t.url),exact:t.exact??!1,defaultContent:t.defaultContent||""});const n=o.currentRoutes;for(const e in n){if(!Object.hasOwn(n,e))continue;const r=n[e];if(!0===r.exact&&e!==t.targetID){let t=document.getElementById(e);if(t)try{y(t,"<div>"+r.defaultContent+"</div>",{childrenOnly:!0})}catch{t.innerHTML=r.defaultContent}delete n[e]}}const a=async()=>{const n=await r(t.content);try{y(e,n,{childrenOnly:!0})}catch{e.innerHTML=n.innerHTML}o.runStyles()},i=async()=>{o.clearEffects(),o.clearExecutedScripts(),o.runScripts(),t?.reloadTime&&setTimeout(g.reloadComponent,t.reloadTime),o.emit("load",{route:t.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(a).finished.then(i).catch(e=>{o.emit("load",{route:location.href,success:!1,error:e||"Unknown error during view transition"})}):(a(),i())}else location.reload()}),"undefined"!=typeof window&&(window.phpspa=v,window.setState!==v.setState&&(window.setState=v.setState),window.__call!==v.__call&&(window.__call=v.__call),window.useEffect!==v.useEffect&&(window.useEffect=v.useEffect),window.useCallback!==v.useCallback&&(window.useCallback=v.useCallback));const b=v.setState.bind(v),E=v.useEffect.bind(v),C=v.useCallback.bind(v),w=v.__call.bind(v);e.__call=w,e.default=v,e.setState=b,e.useCallback=C,e.useEffect=E,Object.defineProperty(e,"__esModule",{value:!0})});
