!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).phpspa={})}(this,function(t){"use strict";function e(t){try{return btoa(t)}catch(e){try{const e=(new TextEncoder).encode(t),n=Array.from(e,t=>String.fromCharCode(t)).join("");return btoa(n)}catch(e){return btoa(t.split("").map(function(t){return String.fromCharCode(255&t.charCodeAt(0))}).join(""))}}}class n{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static lastEventPayload={};static effects=new Set;static registerEffect(t,e=null){const r=t(),o={callback:t,dependencies:e,cleanup:"function"==typeof r?r:null};n.effects.add(o)}static triggerEffects(t,e){n.effects.forEach(e=>{if(null===e.dependencies||e.dependencies.includes(t)){e.cleanup&&e.cleanup();const t=e.callback();e.cleanup="function"==typeof t?t:null}})}static clearEffects(){n.effects.forEach(t=>{t.cleanup&&t.cleanup()}),n.effects.clear()}static runAll(){for(const t in n.currentRoutes){const e=document.getElementById(t);e&&(this.runInlineScripts(e),this.runPhpSpaScripts(e),this.runInlineStyles(e))}}static runInlineScripts(t){const n=t.querySelectorAll("script"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedScripts.has(n)&&""!==t.textContent.trim()){this.executedScripts.add(n);const e=document.createElement("script");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);const o=t.hasAttribute("async");e.textContent=o?`(async function() {\n${t.textContent}\n})();`:`(function() {\n${t.textContent}\n})();`,document.head.appendChild(e).remove()}})}static runPhpSpaScripts(t){t.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]').forEach(async t=>{const e=t.getAttribute("src")??"",n=t.getAttribute("type")??"",r=document.documentElement.getAttribute("x-phpspa");if(!this.executedScripts.has(e)){if(this.executedScripts.add(e),this.ScriptsCachedContent[e]){const t=document.createElement("script");return t.textContent=this.ScriptsCachedContent[e],t.nonce=r??void 0,t.type=n,void document.head.appendChild(t).remove()}const t=await fetch(e,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(t.ok){const o=await t.text(),a=document.createElement("script");a.textContent=o,a.nonce=r??void 0,a.type=n,document.head.appendChild(a).remove(),this.ScriptsCachedContent[e]=o}else console.error(`Failed to load script from ${e}: ${t.statusText}`)}})}static clearExecutedScripts(){n.executedScripts.clear()}static runInlineStyles(t){const n=t.querySelectorAll("style"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedStyles.has(n)&&""!==t.textContent.trim()){this.executedStyles.add(n);const e=document.createElement("style");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);e.textContent=t.textContent,document.head.appendChild(e).remove()}})}static emit(t,e){const n=this.events[t]||[];this.lastEventPayload[t]=e;for(const r of n)if("function"==typeof r)try{r(e)}catch(e){console.error(`Error in ${t} event callback:`,e)}}static getLastEventPayload(t){return this.lastEventPayload[t]}static pushState(t,e,n){try{history.pushState(t,e,n)}catch(t){console.warn("Failed to push history state:",t instanceof Error?t.message:t)}}static replaceState(t,e,n){try{history.replaceState(t,e,n)}catch(t){console.warn("Failed to replace history state:",t instanceof Error?t.message:t)}}}var r;var o="undefined"==typeof document?void 0:document,a=!!o&&"content"in o.createElement("template"),i=!!o&&o.createRange&&"createContextualFragment"in o.createRange();function c(t){return t=t.trim(),a?function(t){var e=o.createElement("template");return e.innerHTML=t,e.content.childNodes[0]}(t):i?function(t){return r||(r=o.createRange()).selectNode(o.body),r.createContextualFragment(t).childNodes[0]}(t):function(t){var e=o.createElement("body");return e.innerHTML=t,e.childNodes[0]}(t)}function s(t,e){var n,r,o=t.nodeName,a=e.nodeName;return o===a||(n=o.charCodeAt(0),r=a.charCodeAt(0),n<=90&&r>=97?o===a.toUpperCase():r<=90&&n>=97&&a===o.toUpperCase())}function l(t,e,n){t[n]!==e[n]&&(t[n]=e[n],t[n]?t.setAttribute(n,""):t.removeAttribute(n))}var d={OPTION:function(t,e){var n=t.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(t.hasAttribute("selected")&&!e.selected&&(t.setAttribute("selected","selected"),t.removeAttribute("selected")),n.selectedIndex=-1)}l(t,e,"selected")},INPUT:function(t,e){l(t,e,"checked"),l(t,e,"disabled"),t.value!==e.value&&(t.value=e.value),e.hasAttribute("value")||t.removeAttribute("value")},TEXTAREA:function(t,e){var n=e.value;t.value!==n&&(t.value=n);var r=t.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==t.placeholder)return;r.nodeValue=n}},SELECT:function(t,e){if(!e.hasAttribute("multiple")){for(var n,r,o=-1,a=0,i=t.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){o=a;break}a++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}t.selectedIndex=o}}};function u(){}function f(t){if(t)return t.getAttribute&&t.getAttribute("id")||t.id}var p=function(t){return function(e,n,r){if(r||(r={}),"string"==typeof n)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var a=n;(n=o.createElement("html")).innerHTML=a}else n=c(n);else 11===n.nodeType&&(n=n.firstElementChild);var i=r.getNodeKey||f,l=r.onBeforeNodeAdded||u,p=r.onNodeAdded||u,h=r.onBeforeElUpdated||u,m=r.onElUpdated||u,g=r.onBeforeNodeDiscarded||u,y=r.onNodeDiscarded||u,v=r.onBeforeElChildrenUpdated||u,S=r.skipFromChildren||u,E=r.addChild||function(t,e){return t.appendChild(e)},b=!0===r.childrenOnly,C=Object.create(null),x=[];function T(t){x.push(t)}function A(t,e){if(1===t.nodeType)for(var n=t.firstChild;n;){var r=void 0;e&&(r=i(n))?T(r):(y(n),n.firstChild&&A(n,e)),n=n.nextSibling}}function w(t,e,n){!1!==g(t)&&(e&&e.removeChild(t),y(t),A(t,n))}function N(t){if(1===t.nodeType||11===t.nodeType)for(var e=t.firstChild;e;){var n=i(e);n&&(C[n]=e),N(e),e=e.nextSibling}}function I(t){p(t);for(var e=t.firstChild;e;){var n=e.nextSibling,r=i(e);if(r){var o=C[r];o&&s(e,o)?(e.parentNode.replaceChild(o,e),O(o,e)):I(e)}else I(e);e=n}}function O(e,n,r){var a=i(n);if(a&&delete C[a],!r){var c=h(e,n);if(!1===c)return;if(c instanceof HTMLElement&&N(e=c),t(e,n),m(e),!1===v(e,n))return}"TEXTAREA"!==e.nodeName?function(t,e){var n,r,a,c,u,f=S(t,e),p=e.firstChild,h=t.firstChild;t:for(;p;){for(c=p.nextSibling,n=i(p);!f&&h;){if(a=h.nextSibling,p.isSameNode&&p.isSameNode(h)){p=c,h=a;continue t}r=i(h);var m=h.nodeType,g=void 0;if(m===p.nodeType&&(1===m?(n?n!==r&&((u=C[n])?a===u?g=!1:(t.insertBefore(u,h),r?T(r):w(h,t,!0),r=i(h=u)):g=!1):r&&(g=!1),(g=!1!==g&&s(h,p))&&O(h,p)):3!==m&&8!=m||(g=!0,h.nodeValue!==p.nodeValue&&(h.nodeValue=p.nodeValue))),g){p=c,h=a;continue t}r?T(r):w(h,t,!0),h=a}if(n&&(u=C[n])&&s(u,p))f||E(t,u),O(u,p);else{var y=l(p);!1!==y&&(y&&(p=y),p.actualize&&(p=p.actualize(t.ownerDocument||o)),E(t,p),I(p))}p=c,h=a}!function(t,e,n){for(;e;){var r=e.nextSibling;(n=i(e))?T(n):w(e,t,!0),e=r}}(t,h,r);var v=d[t.nodeName];v&&v(t,e)}(e,n):d.TEXTAREA(e,n)}N(e);var R,P,D=e,L=D.nodeType,U=n.nodeType;if(!b)if(1===L)1===U?s(e,n)||(y(e),D=function(t,e){for(var n=t.firstChild;n;){var r=n.nextSibling;e.appendChild(n),n=r}return e}(e,(R=n.nodeName,(P=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==P?o.createElementNS(P,R):o.createElement(R)))):D=n;else if(3===L||8===L){if(U===L)return D.nodeValue!==n.nodeValue&&(D.nodeValue=n.nodeValue),D;D=n}if(D===n)y(e);else{if(n.isSameNode&&n.isSameNode(D))return;if(O(D,n,b),x)for(var _=0,k=x.length;_<k;_++){var B=C[x[_]];B&&w(B,B.parentNode,!1)}}return!b&&D!==e&&e.parentNode&&(D.actualize&&(D=D.actualize(e.ownerDocument||o)),e.parentNode.replaceChild(D,e)),D}}(function(t,e){var n,r,o,a,i=e.attributes;if(11!==e.nodeType&&11!==t.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,o=n.namespaceURI,a=n.value,o?(r=n.localName||r,t.getAttributeNS(o,r)!==a&&("xmlns"===n.prefix&&(r=n.name),t.setAttributeNS(o,r,a))):t.getAttribute(r)!==a&&t.setAttribute(r,a);for(var s=t.attributes,l=s.length-1;l>=0;l--)r=(n=s[l]).name,(o=n.namespaceURI)?(r=n.localName||r,e.hasAttributeNS(o,r)||t.removeAttributeNS(o,r)):e.hasAttribute(r)||t.removeAttribute(r)}});class h{static navigate(t,e="push"){const r=t instanceof URL?t:new URL(t,location.toString());function o(t){t.response?t.response.text().then(e=>{let o;try{o=e?.trim().startsWith("{")?JSON.parse(e):e}catch(t){o=e}a(o||""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"Server returned an error",data:o})}).catch(()=>{a(""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"Failed to read error response"})}):(a(""),n.emit("load",{route:r.toString(),success:!1,error:t.message||"No connection to server"}))}function a(t){const o="string"==typeof t?{content:t}:t;o?.title&&o.title.length>0&&(document.title=o.title);const a=document.getElementById(o?.targetID)??document.getElementById(history.state?.targetID)??document.body;o?.targetID&&(n.currentRoutes[o.targetID]={route:r,exact:o.exact??!1,defaultContent:n.currentRoutes[o.targetID]?.defaultContent??a.innerHTML});const i=n.currentRoutes;for(const t in i){if(!Object.hasOwn(i,t))continue;const e=i[t];if(!0===e.exact&&t!==o?.targetID){let n=document.getElementById(t);if(n)try{p(n,"<div>"+e.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=e.defaultContent}delete i[t]}}const c=()=>{try{p(a,"<div>"+o.content+"</div>",{childrenOnly:!0})}catch{a.innerHTML=o.content}},s={url:r.toString(),title:o?.title??document.title,targetID:a.id,content:o.content,exact:i[o?.targetID]?.exact,defaultContent:i[o?.targetID]?.defaultContent};o?.reloadTime&&(s.reloadTime=o.reloadTime);const l=()=>{"push"===e?n.pushState(s,s.title,r):"replace"===e&&n.replaceState(s,s.title,r);const t=document.getElementById(r.hash.substring(1));t?scroll({top:t.offsetTop,left:t.offsetLeft}):scroll(0,0),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),n.emit("load",{route:r.toString(),success:!0,error:!1}),o?.reloadTime&&setTimeout(h.reloadComponent,o.reloadTime)};document.startViewTransition?document.startViewTransition(c).finished.then(l).catch(t=>{n.emit("load",{route:r.toString(),success:!1,error:t||"Unknown error during view transition"})}):(c(),l())}n.emit("beforeload",{route:r.toString()}),fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(t=>{let e;if(t&&t.trim().startsWith("{"))try{e=JSON.parse(t)}catch(n){e=t}else e=t||"";a(e)}).catch(t=>o(t))}).catch(t=>o(t))}static back(){history.back()}static forward(){history.forward()}static reload(){h.navigate(location.toString(),"replace")}static on(t,e){n.events[t]||(n.events[t]=[]),n.events[t].push(e);const r=n.getLastEventPayload(t);if(r)try{e(r)}catch(e){console.error(`Error in ${t} event callback:`,e)}}static useEffect(t,e=null){n.registerEffect(t,e)}static setState(t,r){return new Promise(async(o,a)=>{const i=n.currentRoutes,c=JSON.stringify({state:{key:t,value:r}}),s=[];for(const t in i){if(!Object.hasOwn(i,t))continue;const{route:n}=i[t],r=fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0});s.push(r)}function l(e){const o="string"==typeof e?{content:e}:e;o?.title&&String(o.title).length>0&&(document.title=o.title);const a=document.getElementById(o?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{p(a,"<div>"+o.content+"</div>",{childrenOnly:!0})}catch{a.innerHTML=o.content}})(),n.triggerEffects(t,r)}(await Promise.all(s)).forEach(async t=>{try{const e=await t.text();let n;if(e&&e.trim().startsWith("{"))try{n=JSON.parse(e)}catch(t){n=e}else n=e||"";o(),l(n)}catch(t){a(t),function(t){t?.response?t.response.text().then(t=>{let e;try{e=t?.trim().startsWith("{")?JSON.parse(t):t}catch(n){e=t}l(e||"")}).catch(()=>{l("")}):l("")}(t)}})})}static reloadComponent(){function t(t){t?.response?t.response.text().then(t=>{let n;try{n=t?.trim().startsWith("{")?JSON.parse(t):t}catch(e){n=t}e(n||"")}).catch(()=>{e("")}):e("")}function e(t){const e="string"==typeof t?{content:t}:t;e?.title&&String(e.title).length>0&&(document.title=e.title);const r=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{p(r,"<div>"+e.content+"</div>",{childrenOnly:!0})}catch{r.innerHTML=e.content}})(),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),e?.reloadTime&&setTimeout(h.reloadComponent,e.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(n=>{n.text().then(t=>{let n;if(t&&t.trim().startsWith("{"))try{n=JSON.parse(t)}catch(e){n=t}else n=t||"";e(n)}).catch(e=>{t(e)})}).catch(e=>{t(e)})}static async __call(t,...n){const r=JSON.stringify({__call:{token:t,args:n}});try{const t=await fetch(location.pathname,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(r)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await t.text();let o;if(n&&n.trim().startsWith("{"))try{o=JSON.parse(n),o=o?.response?JSON.parse(o.response):o}catch(t){o=n}else o=n||"";return o}catch(t){if(!t?.response)return"";try{const e=await t.response.text();let n;try{n=e?.trim().startsWith("{")?JSON.parse(e):e,n=n?.response?JSON.parse(n.response):n}catch(t){n=e}return n}catch{return""}}}}function m(){const t=document.querySelector("[data-phpspa-target]"),e=document.querySelector("[phpspa-target-data]"),r=location.toString();if(n.emit("load",{route:r,success:!0,error:!1}),t){const o={url:r,title:document.title,targetID:t.id,content:t.innerHTML,root:!0};if(t.hasAttribute("phpspa-reload-time")&&(o.reloadTime=Number(t.getAttribute("phpspa-reload-time"))),e){const a=e.getAttribute("phpspa-target-data"),i=JSON.parse(function(t){try{const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return(new TextDecoder).decode(n)}catch(e){return atob(t)}}(a??""));i.targetIDs.forEach((e,a)=>{const c=i.exact[a],s=i.defaultContent[a];e===t.id&&(o.exact=c,o.defaultContent=s),n.currentRoutes[e]={route:new URL(i.currentRoutes[a],r),defaultContent:s,exact:c}})}n.replaceState(o,document.title,r),o.reloadTime&&setTimeout(h.reloadComponent,o.reloadTime)}document.addEventListener("click",t=>{if(t.defaultPrevented||0!==t.button)return;if(t.metaKey||t.ctrlKey||t.shiftKey||t.altKey)return;const e=t.target?.closest?.('a[data-type="phpspa-link-tag"]');if(!e)return;if(e.hasAttribute("download"))return;if(e.getAttribute("target")&&"_self"!==e.getAttribute("target"))return;const n=e.getAttribute("href");if(!n)return;const r=new URL(n,location.toString());r.origin===location.origin&&(t.preventDefault(),h.navigate(r,"push"))})}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",m,{once:!0}):["interactive","complete"].includes(document.readyState)&&m(),window.addEventListener("popstate",t=>{const e=t.state;if(n.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",e&&e.content){document.title=e.title??document.title;const t=document.getElementById(e.targetID);if(!t)return void location.reload();e.targetID&&(n.currentRoutes[e.targetID]={route:new URL(e.url),exact:e.exact??!1,defaultContent:e.defaultContent||""});const r=n.currentRoutes;for(const t in r){if(!Object.hasOwn(r,t))continue;const n=r[t];if(!0===n.exact&&t!==e.targetID){let e=document.getElementById(t);if(e)try{p(e,"<div>"+n.defaultContent+"</div>",{childrenOnly:!0})}catch{e.innerHTML=n.defaultContent}delete r[t]}}const o=()=>{try{p(t,"<div>"+e.content+"</div>",{childrenOnly:!0})}catch{t.innerHTML=e.content}},a=()=>{n.clearEffects(),n.clearExecutedScripts(),n.runAll(),e?.reloadTime&&setTimeout(h.reloadComponent,e.reloadTime),n.emit("load",{route:e.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(o).finished.then(a).catch(t=>{n.emit("load",{route:location.href,success:!1,error:t||"Unknown error during view transition"})}):(o(),a())}else location.reload()}),"undefined"!=typeof window&&(window.phpspa=h,window.setState!==h.setState&&(window.setState=h.setState),window.__call!==h.__call&&(window.__call=h.__call),window.useEffect!==h.useEffect&&(window.useEffect=h.useEffect));const g=h.setState.bind(h),y=h.useEffect.bind(h),v=h.__call.bind(h);t.__call=v,t.default=h,t.setState=g,t.useEffect=y,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=phpspa.min.js.map
