!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).phpspa=t()}(this,function(){"use strict";function e(e){try{return btoa(e)}catch(t){try{const t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}catch(t){return btoa(e.split("").map(function(e){return String.fromCharCode(255&e.charCodeAt(0))}).join(""))}}}class t{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static effects=new Set;static registerEffect(e,n=null){const r=e(),o={callback:e,dependencies:n,cleanup:"function"==typeof r?r:null};t.effects.add(o)}static triggerEffects(e,n){t.effects.forEach(t=>{if(null===t.dependencies||t.dependencies.includes(e)){t.cleanup&&t.cleanup();const e=t.callback();t.cleanup="function"==typeof e?e:null}})}static clearEffects(){t.effects.forEach(e=>{e.cleanup&&e.cleanup()}),t.effects.clear()}static runAll(){for(const e in t.currentRoutes){const t=document.getElementById(e);t&&(this.runInlineScripts(t),this.runPhpSpaScripts(t),this.runInlineStyles(t))}}static runInlineScripts(t){const n=t.querySelectorAll("script"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedScripts.has(n)&&""!==t.textContent.trim()){this.executedScripts.add(n);const e=document.createElement("script");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);const o=t.hasAttribute("async");e.textContent=o?`(async function() {\n${t.textContent}\n})();`:`(function() {\n${t.textContent}\n})();`,document.head.appendChild(e).remove()}})}static runPhpSpaScripts(e){e.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]').forEach(async e=>{const t=e.getAttribute("src")??"",n=e.getAttribute("type")??"",r=document.documentElement.getAttribute("x-phpspa");if(!this.executedScripts.has(t)){if(this.executedScripts.add(t),this.ScriptsCachedContent[t]){const e=document.createElement("script");return e.textContent=this.ScriptsCachedContent[t],e.nonce=r??void 0,e.type=n,void document.head.appendChild(e).remove()}const e=await fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(e.ok){const o=await e.text(),i=document.createElement("script");i.textContent=o,i.nonce=r??void 0,i.type=n,document.head.appendChild(i).remove(),this.ScriptsCachedContent[t]=o}else console.error(`Failed to load script from ${t}: ${e.statusText}`)}})}static clearExecutedScripts(){t.executedScripts.clear()}static runInlineStyles(t){const n=t.querySelectorAll("style"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedStyles.has(n)&&""!==t.textContent.trim()){this.executedStyles.add(n);const e=document.createElement("style");e.nonce=r??void 0;for(const n of Array.from(t.attributes))e.setAttribute(n.name,n.value);e.textContent=t.textContent,document.head.appendChild(e).remove()}})}static emit(e,t){const n=this.events[e]||[];for(const r of n)if("function"==typeof r)try{r(t)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static pushState(e,t,n){try{history.pushState(e,t,n)}catch(e){console.warn("Failed to push history state:",e instanceof Error?e.message:e)}}static replaceState(e,t,n){try{history.replaceState(e,t,n)}catch(e){console.warn("Failed to replace history state:",e instanceof Error?e.message:e)}}}var n;var r="undefined"==typeof document?void 0:document,o=!!r&&"content"in r.createElement("template"),i=!!r&&r.createRange&&"createContextualFragment"in r.createRange();function a(e){return e=e.trim(),o?function(e){var t=r.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):i?function(e){return n||(n=r.createRange()).selectNode(r.body),n.createContextualFragment(e).childNodes[0]}(e):function(e){var t=r.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function c(e,t){var n,r,o=e.nodeName,i=t.nodeName;return o===i||(n=o.charCodeAt(0),r=i.charCodeAt(0),n<=90&&r>=97?o===i.toUpperCase():r<=90&&n>=97&&i===o.toUpperCase())}function s(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var l={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}s(e,t,"selected")},INPUT:function(e,t){s(e,t,"checked"),s(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,i=0,a=e.firstChild;a;)if("OPTGROUP"===(r=a.nodeName&&a.nodeName.toUpperCase()))(a=(n=a).firstChild)||(a=n.nextSibling,n=null);else{if("OPTION"===r){if(a.hasAttribute("selected")){o=i;break}i++}!(a=a.nextSibling)&&n&&(a=n.nextSibling,n=null)}e.selectedIndex=o}}};function d(){}function u(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var f=function(e){return function(t,n,o){if(o||(o={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var i=n;(n=r.createElement("html")).innerHTML=i}else n=a(n);else 11===n.nodeType&&(n=n.firstElementChild);var s=o.getNodeKey||u,f=o.onBeforeNodeAdded||d,p=o.onNodeAdded||d,h=o.onBeforeElUpdated||d,m=o.onElUpdated||d,g=o.onBeforeNodeDiscarded||d,y=o.onNodeDiscarded||d,S=o.onBeforeElChildrenUpdated||d,v=o.skipFromChildren||d,C=o.addChild||function(e,t){return e.appendChild(t)},E=!0===o.childrenOnly,b=Object.create(null),x=[];function T(e){x.push(e)}function A(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=s(n))?T(r):(y(n),n.firstChild&&A(n,t)),n=n.nextSibling}}function w(e,t,n){!1!==g(e)&&(t&&t.removeChild(e),y(e),A(e,n))}function N(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=s(t);n&&(b[n]=t),N(t),t=t.nextSibling}}function I(e){p(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=s(t);if(r){var o=b[r];o&&c(t,o)?(t.parentNode.replaceChild(o,t),O(o,t)):I(t)}else I(t);t=n}}function O(t,n,o){var i=s(n);if(i&&delete b[i],!o){var a=h(t,n);if(!1===a)return;if(a instanceof HTMLElement&&N(t=a),e(t,n),m(t),!1===S(t,n))return}"TEXTAREA"!==t.nodeName?function(e,t){var n,o,i,a,d,u=v(e,t),p=t.firstChild,h=e.firstChild;e:for(;p;){for(a=p.nextSibling,n=s(p);!u&&h;){if(i=h.nextSibling,p.isSameNode&&p.isSameNode(h)){p=a,h=i;continue e}o=s(h);var m=h.nodeType,g=void 0;if(m===p.nodeType&&(1===m?(n?n!==o&&((d=b[n])?i===d?g=!1:(e.insertBefore(d,h),o?T(o):w(h,e,!0),o=s(h=d)):g=!1):o&&(g=!1),(g=!1!==g&&c(h,p))&&O(h,p)):3!==m&&8!=m||(g=!0,h.nodeValue!==p.nodeValue&&(h.nodeValue=p.nodeValue))),g){p=a,h=i;continue e}o?T(o):w(h,e,!0),h=i}if(n&&(d=b[n])&&c(d,p))u||C(e,d),O(d,p);else{var y=f(p);!1!==y&&(y&&(p=y),p.actualize&&(p=p.actualize(e.ownerDocument||r)),C(e,p),I(p))}p=a,h=i}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=s(t))?T(n):w(t,e,!0),t=r}}(e,h,o);var S=l[e.nodeName];S&&S(e,t)}(t,n):l.TEXTAREA(t,n)}N(t);var R,P,D=t,U=D.nodeType,L=n.nodeType;if(!E)if(1===U)1===L?c(t,n)||(y(t),D=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(t,(R=n.nodeName,(P=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==P?r.createElementNS(P,R):r.createElement(R)))):D=n;else if(3===U||8===U){if(L===U)return D.nodeValue!==n.nodeValue&&(D.nodeValue=n.nodeValue),D;D=n}if(D===n)y(t);else{if(n.isSameNode&&n.isSameNode(D))return;if(O(D,n,E),x)for(var B=0,H=x.length;B<H;B++){var k=b[x[B]];k&&w(k,k.parentNode,!1)}}return!E&&D!==t&&t.parentNode&&(D.actualize&&(D=D.actualize(t.ownerDocument||r)),t.parentNode.replaceChild(D,t)),D}}(function(e,t){var n,r,o,i,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var c=a.length-1;c>=0;c--)r=(n=a[c]).name,o=n.namespaceURI,i=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==i&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,i))):e.getAttribute(r)!==i&&e.setAttribute(r,i);for(var s=e.attributes,l=s.length-1;l>=0;l--)r=(n=s[l]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}});class p{static navigate(e,n="push"){const r=e instanceof URL?e:new URL(e,location.toString());function o(e){e.response?e.response.text().then(n=>{let o;try{o=n?.trim().startsWith("{")?JSON.parse(n):n}catch(e){o=n}i(o||""),t.emit("load",{route:r.toString(),success:!1,error:e.message||"Server returned an error",data:o})}).catch(()=>{i(""),t.emit("load",{route:r.toString(),success:!1,error:e.message||"Failed to read error response"})}):(i(""),t.emit("load",{route:r.toString(),success:!1,error:e.message||"No connection to server"}))}function i(e){const o="string"==typeof e?{content:e}:e;o?.title&&o.title.length>0&&(document.title=o.title);const i=document.getElementById(o?.targetID)??document.getElementById(history.state?.targetID)??document.body;o?.targetID&&(t.currentRoutes[o.targetID]={route:r,exact:o.exact??!1,defaultContent:t.currentRoutes[o.targetID]?.defaultContent??i.innerHTML});const a=t.currentRoutes;for(const e in a){if(!Object.hasOwn(a,e))continue;const t=a[e];if(!0===t.exact&&e!==o?.targetID){let n=document.getElementById(e);if(n)try{f(n,"<div>"+t.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t.defaultContent}delete a[e]}}const c=()=>{try{f(i,"<div>"+o.content+"</div>",{childrenOnly:!0})}catch{i.innerHTML=o.content}},s={url:r.toString(),title:o?.title??document.title,targetID:i.id,content:o.content,exact:a[o?.targetID]?.exact,defaultContent:a[o?.targetID]?.defaultContent};o?.reloadTime&&(s.reloadTime=o.reloadTime);const l=()=>{"push"===n?t.pushState(s,s.title,r):"replace"===n&&t.replaceState(s,s.title,r);const e=document.getElementById(r.hash.substring(1));e?scroll({top:e.offsetTop,left:e.offsetLeft}):scroll(0,0),t.clearEffects(),t.clearExecutedScripts(),t.runAll(),t.emit("load",{route:r.toString(),success:!0,error:!1}),o?.reloadTime&&setTimeout(p.reloadComponent,o.reloadTime)};document.startViewTransition?document.startViewTransition(c).finished.then(l).catch(e=>{t.emit("load",{route:r.toString(),success:!1,error:e||"Unknown error during view transition"})}):(c(),l())}t.emit("beforeload",{route:r.toString()}),fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";i(t)}).catch(e=>o(e))}).catch(e=>o(e))}static back(){history.back()}static forward(){history.forward()}static reload(){p.navigate(location.toString(),"replace")}static on(e,n){t.events[e]||(t.events[e]=[]),t.events[e].push(n)}static useEffect(e,n=null){t.registerEffect(e,n)}static setState(n,r){return new Promise(async(o,i)=>{const a=t.currentRoutes,c=JSON.stringify({state:{key:n,value:r}}),s=[];for(const t in a){if(!Object.hasOwn(a,t))continue;const{route:n}=a[t],r=fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0});s.push(r)}function l(e){const o="string"==typeof e?{content:e}:e;o?.title&&String(o.title).length>0&&(document.title=o.title);const i=document.getElementById(o?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{f(i,"<div>"+o.content+"</div>",{childrenOnly:!0})}catch{i.innerHTML=o.content}})(),t.triggerEffects(n,r)}(await Promise.all(s)).forEach(async e=>{try{const t=await e.text();let n;if(t&&t.trim().startsWith("{"))try{n=JSON.parse(t)}catch(e){n=t}else n=t||"";o(),l(n)}catch(e){i(e),function(e){e?.response?e.response.text().then(e=>{let t;try{t=e?.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}l(t||"")}).catch(()=>{l("")}):l("")}(e)}})})}static reloadComponent(){function e(e){e?.response?e.response.text().then(e=>{let t;try{t=e?.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}n(t||"")}).catch(()=>{n("")}):n("")}function n(e){const n="string"==typeof e?{content:e}:e;n?.title&&String(n.title).length>0&&(document.title=n.title);const r=document.getElementById(n?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{f(r,"<div>"+n.content+"</div>",{childrenOnly:!0})}catch{r.innerHTML=n.content}})(),t.clearEffects(),t.clearExecutedScripts(),t.runAll(),n?.reloadTime&&setTimeout(p.reloadComponent,n.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(t=>{t.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";n(t)}).catch(t=>{e(t)})}).catch(t=>{e(t)})}static async __call(t,...n){const r=JSON.stringify({__call:{token:t,args:n}});try{const t=await fetch(location.pathname,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(r)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await t.text();let o;if(n&&n.trim().startsWith("{"))try{o=JSON.parse(n),o=o?.response?JSON.parse(o.response):o}catch(e){o=n}else o=n||"";return o}catch(e){if(!e?.response)return"";try{const t=await e.response.text();let n;try{n=t?.trim().startsWith("{")?JSON.parse(t):t,n=n?.response?JSON.parse(n.response):n}catch(e){n=t}return n}catch{return""}}}}return window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-phpspa-target]"),n=document.querySelector("[phpspa-target-data]"),r=location.toString();if(t.emit("load",{route:r,success:!0,error:!1}),e){const o={url:r,title:document.title,targetID:e.id,content:e.innerHTML,root:!0};if(e.hasAttribute("phpspa-reload-time")&&(o.reloadTime=Number(e.getAttribute("phpspa-reload-time"))),n){const i=n.getAttribute("phpspa-target-data"),a=JSON.parse(function(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return(new TextDecoder).decode(n)}catch(t){return atob(e)}}(i??""));a.targetIDs.forEach((n,i)=>{const c=a.exact[i],s=a.defaultContent[i];n===e.id&&(o.exact=c,o.defaultContent=s),t.currentRoutes[n]={route:new URL(a.currentRoutes[i],r),defaultContent:s,exact:c}})}t.replaceState(o,document.title,r),o.reloadTime&&setTimeout(p.reloadComponent,o.reloadTime)}}),window.addEventListener("popstate",e=>{const n=e.state;if(t.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",n&&n.content){document.title=n.title??document.title;const e=document.getElementById(n.targetID);if(!e)return void location.reload();n.targetID&&(t.currentRoutes[n.targetID]={route:new URL(n.url),exact:n.exact??!1,defaultContent:n.defaultContent||""});const r=t.currentRoutes;for(const e in r){if(!Object.hasOwn(r,e))continue;const t=r[e];if(!0===t.exact&&e!==n.targetID){let n=document.getElementById(e);if(n)try{f(n,"<div>"+t.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t.defaultContent}delete r[e]}}const o=()=>{try{f(e,"<div>"+n.content+"</div>",{childrenOnly:!0})}catch{e.innerHTML=n.content}},i=()=>{t.clearEffects(),t.clearExecutedScripts(),t.runAll(),n?.reloadTime&&setTimeout(p.reloadComponent,n.reloadTime),t.emit("load",{route:n.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(o).finished.then(i).catch(e=>{t.emit("load",{route:location.href,success:!1,error:e||"Unknown error during view transition"})}):(o(),i())}else location.reload()}),"undefined"!=typeof window&&("function"!=typeof window.setState&&(window.setState=p.setState),"function"!=typeof window.__call&&(window.__call=p.__call),"function"!=typeof window.useEffect&&(window.useEffect=p.useEffect)),p});
//# sourceMappingURL=phpspa.min.js.map
