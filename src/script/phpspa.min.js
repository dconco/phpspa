/**
 * ===========================================================
 *   _____    _             _____  _____
 *  |  __ \  | |           / ____||  __ \  /\    
 *  | |__) | | |__   _ __ | (___  | |__) |/  \   
 *  |  ___/  | '_ \ | '_ \ \___ \ |  ___// /\ \  
 *  | |      | | | || |_) |____) || |   / ____ \ 
 *  |_|      |_| |_|| .__/|_____/ |_|  /_/    \_\
 *                  | |
 *                  |_|
 * 
 * ===========================================================
 * 
 * PhpSPA JavaScript Engine
 *
 * A lightweight JavaScript engine for PHP-powered single-page applications.
 * Handles SPA-style navigation, content replacement, and lifecycle events
 * without full page reloads. Designed to pair with the `PhpSPA` PHP framework.
 *
 * Note:
 * - All scripts and logic must be attached per component using `$component->script(...)`.
 * - This library assumes server-rendered HTML responses with placeholder target IDs.
 *
 * @author Dave Conco <me@dconco.tech>
 * @link https://github.com/dconco/phpspa-js
 * @version 2.0.1
 * @license MIT
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof self?self:this).phpspa=t()}("undefined"!=typeof self&&self,function(){"use strict";function e(e){try{return btoa(e)}catch(t){try{const t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}catch(t){return btoa(e.split("").map(function(e){return String.fromCharCode(255&e.charCodeAt(0))}).join(""))}}}var t;var n="undefined"==typeof document?void 0:document,r=!!n&&"content"in n.createElement("template"),o=!!n&&n.createRange&&"createContextualFragment"in n.createRange();function a(e){return e=e.trim(),r?function(e){var t=n.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):o?function(e){return t||(t=n.createRange()).selectNode(n.body),t.createContextualFragment(e).childNodes[0]}(e):function(e){var t=n.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function i(e,t){var n,r,o=e.nodeName,a=t.nodeName;return o===a||(n=o.charCodeAt(0),r=a.charCodeAt(0),n<=90&&r>=97?o===a.toUpperCase():r<=90&&n>=97&&a===o.toUpperCase())}function c(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var s={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}c(e,t,"selected")},INPUT:function(e,t){c(e,t,"checked"),c(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,a=0,i=e.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){o=a;break}a++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}e.selectedIndex=o}}};function d(){}function l(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var u=function(e){return function(t,r,o){if(o||(o={}),"string"==typeof r)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var c=r;(r=n.createElement("html")).innerHTML=c}else r=a(r);else 11===r.nodeType&&(r=r.firstElementChild);var u=o.getNodeKey||l,h=o.onBeforeNodeAdded||d,f=o.onNodeAdded||d,p=o.onBeforeElUpdated||d,m=o.onElUpdated||d,y=o.onBeforeNodeDiscarded||d,v=o.onNodeDiscarded||d,g=o.onBeforeElChildrenUpdated||d,S=o.skipFromChildren||d,T=o.addChild||function(e,t){return e.appendChild(t)},x=!0===o.childrenOnly,C=Object.create(null),b=[];function w(e){b.push(e)}function E(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=u(n))?w(r):(v(n),n.firstChild&&E(n,t)),n=n.nextSibling}}function A(e,t,n){!1!==y(e)&&(t&&t.removeChild(e),v(e),E(e,n))}function N(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=u(t);n&&(C[n]=t),N(t),t=t.nextSibling}}function I(e){f(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=u(t);if(r){var o=C[r];o&&i(t,o)?(t.parentNode.replaceChild(o,t),D(o,t)):I(t)}else I(t);t=n}}function D(t,r,o){var a=u(r);if(a&&delete C[a],!o){var c=p(t,r);if(!1===c)return;if(c instanceof HTMLElement&&N(t=c),e(t,r),m(t),!1===g(t,r))return}"TEXTAREA"!==t.nodeName?function(e,t){var r,o,a,c,d,l=S(e,t),f=t.firstChild,p=e.firstChild;e:for(;f;){for(c=f.nextSibling,r=u(f);!l&&p;){if(a=p.nextSibling,f.isSameNode&&f.isSameNode(p)){f=c,p=a;continue e}o=u(p);var m=p.nodeType,y=void 0;if(m===f.nodeType&&(1===m?(r?r!==o&&((d=C[r])?a===d?y=!1:(e.insertBefore(d,p),o?w(o):A(p,e,!0),o=u(p=d)):y=!1):o&&(y=!1),(y=!1!==y&&i(p,f))&&D(p,f)):3!==m&&8!=m||(y=!0,p.nodeValue!==f.nodeValue&&(p.nodeValue=f.nodeValue))),y){f=c,p=a;continue e}o?w(o):A(p,e,!0),p=a}if(r&&(d=C[r])&&i(d,f))l||T(e,d),D(d,f);else{var v=h(f);!1!==v&&(v&&(f=v),f.actualize&&(f=f.actualize(e.ownerDocument||n)),T(e,f),I(f))}f=c,p=a}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=u(t))?w(n):A(t,e,!0),t=r}}(e,p,o);var g=s[e.nodeName];g&&g(e,t)}(t,r):s.TEXTAREA(t,r)}N(t);var O,R,U=t,P=U.nodeType,L=r.nodeType;if(!x)if(1===P)1===L?i(t,r)||(v(t),U=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(t,(O=r.nodeName,(R=r.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==R?n.createElementNS(R,O):n.createElement(O)))):U=r;else if(3===P||8===P){if(L===P)return U.nodeValue!==r.nodeValue&&(U.nodeValue=r.nodeValue),U;U=r}if(U===r)v(t);else{if(r.isSameNode&&r.isSameNode(U))return;if(D(U,r,x),b)for(var B=0,H=b.length;B<H;B++){var V=C[b[B]];V&&A(V,V.parentNode,!1)}}return!x&&U!==t&&t.parentNode&&(U.actualize&&(U=U.actualize(t.ownerDocument||n)),t.parentNode.replaceChild(U,t)),U}}(function(e,t){var n,r,o,a,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,o=n.namespaceURI,a=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==a&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,a))):e.getAttribute(r)!==a&&e.setAttribute(r,a);for(var s=e.attributes,d=s.length-1;d>=0;d--)r=(n=s[d]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}});window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-phpspa-target]");if(f.emit("load",{route:location.href,success:!0,error:!1}),e){const t={url:location.href,title:document.title,targetID:e.id,content:e.innerHTML,root:!0};e.hasAttribute("phpspa-reload-time")&&(t.reloadTime=Number(e.getAttribute("phpspa-reload-time"))),e.hasAttribute("phpspa-target-exact")&&(t.exact=!0,t.exactTargetID=e.id,t.defaultContent=function(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return(new TextDecoder).decode(n)}catch(t){return atob(e)}}(e.getAttribute("phpspa-target-exact"))),f.replaceState(t,document.title,location.href),f.currentState=t,e.hasAttribute("phpspa-reload-time")&&setTimeout(h.reloadComponent,t.reloadTime)}}),document.addEventListener("click",e=>{const t=e.target.closest('a[data-type="phpspa-link-tag"]');t&&(e.preventDefault(),h.navigate(new URL(t.href,location.href),"push"))}),window.addEventListener("popstate",e=>{const t=e.state;if(f.emit("beforeload",{route:location.href}),history.scrollRestoration="auto",t&&t.content){document.title=t.title??document.title;const e=document.getElementById(t.targetID)??document.body,n=f.currentState;if(!0===n?.exact&&n.exactTargetID!==t.targetID){let e=document.getElementById(n.exactTargetID);if(e)try{u(e,"<div>"+n.defaultContent+"</div>",{childrenOnly:!0})}catch{e.innerHTML=n.defaultContent}}const r=()=>{try{u(e,"<div>"+t.content+"</div>",{childrenOnly:!0})}catch{e.innerHTML=t.content}},o=()=>{f.clearExecutedScripts(),f.runAll(t.root?document.body:e),void 0!==t.reloadTime&&setTimeout(h.reloadComponent,t.reloadTime),f.emit("load",{route:location.href,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(r).finished.then(o).catch(e=>{f.emit("load",{route:location.href,success:!1,error:e||"Unknown error during view transition"})}):(r(),o())}else h.navigate(new URL(location.href),"replace")});class h{static navigate(e,t="push"){function n(t){t.response?t.response.text().then(n=>{let o;try{o=n.trim().startsWith("{")?JSON.parse(n):n}catch(e){o=n}r(o||""),f.emit("load",{route:e,success:!1,error:t.message||"Server returned an error",data:o})}).catch(()=>{r(""),f.emit("load",{route:e,success:!1,error:t.message||"Failed to read error response"})}):(r(""),f.emit("load",{route:e,success:!1,error:t.message||"No connection to server"}))}function r(n){"string"!=typeof n?.title&&"number"!=typeof n?.title||(document.title=n.title);const r=document.getElementById(n?.targetID)??document.getElementById(history.state?.targetID)??document.body,o=f.currentState;if(!0===o?.exact&&o.exactTargetID!==n?.targetID){let e=document.getElementById(o.exactTargetID);if(e)try{u(e,"<div>"+o.defaultContent+"</div>",{childrenOnly:!0})}catch{e.innerHTML=o.defaultContent}}const a=()=>{try{u(r,"<div>"+n?.content||n+"</div>",{childrenOnly:!0})}catch{r.innerHTML=n?.content?n.content:n}},i={url:e?.href??e,title:n?.title??document.title,targetID:n?.targetID??r.id,content:n?.content??n,defaultContent:o?.defaultContent,exact:o?.exact,exactTargetID:o?.exactTargetID};document.getElementById(i.exactTargetID)||(i.exact=n?.exact||!1,i.exactTargetID=n?.targetID||r.id,i.defaultContent=document.getElementById(n?.targetID)?.innerHTML||""),void 0!==n.reloadTime&&(i.reloadTime=n.reloadTime);const c=()=>{"push"===t?f.pushState(i,i.title,e):"replace"===t&&f.replaceState(i,i.title,e),f.currentState=history.state;const o=document.getElementById(e?.hash?.substring(1));o?scroll({top:o.offsetTop,left:o.offsetLeft}):scroll(0,0),f.clearExecutedScripts(),f.runAll(r),f.emit("load",{route:e,success:!0,error:!1}),void 0!==n.reloadTime&&setTimeout(h.reloadComponent,n.reloadTime)};document.startViewTransition?document.startViewTransition(a).finished.then(c).catch(t=>{f.emit("load",{route:e,success:!1,error:t||"Unknown error during view transition"})}):(a(),c())}f.emit("beforeload",{route:e}),fetch(e,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";r(t)}).catch(e=>n(e))}).catch(e=>n(e))}static back(){history.back()}static forward(){history.forward()}static reload(){h.navigate(new URL(location.href),"replace")}static on(e,t){f.events[e]||(f.events[e]=[]),f.events[e].push(t)}static setState(t,n){return new Promise((r,o)=>{const a={top:scrollY,left:scrollX},i=new URL(location.href),c=JSON.stringify({state:{key:t,value:n}});function s(e){e.response?e.response.text().then(e=>{let t;try{t=e.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}d(t||"")}).catch(()=>{d("")}):d("")}function d(e){"string"!=typeof e?.title&&"number"!=typeof e?.title||(document.title=e.title);const t=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body,n=()=>{try{u(t,"<div>"+e?.content||e+"</div>",{childrenOnly:!0})}catch{t.innerHTML=e?.content?e.content:e}},r=()=>{scroll(a)};document.startViewTransition?document.startViewTransition(n).finished.then(r):(n(),r())}fetch(i,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";r(),d(t)}).catch(e=>{o(e.message),s(e)})}).catch(e=>{o(e.message),s(e)})})}static reloadComponent(){const e={top:scrollY,left:scrollX};function t(e){e.response?e.response.text().then(e=>{let t;try{t=e.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}n(t||"")}).catch(()=>{n("")}):n("")}function n(t){"string"!=typeof t?.title&&"number"!=typeof t?.title||(document.title=t.title);const n=document.getElementById(t?.targetID)??document.getElementById(history.state?.targetID)??document.body,r=()=>{try{u(n,"<div>"+t?.content||t+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t?.content||t}},o=()=>{f.clearExecutedScripts(),f.runAll(n),scroll(e),void 0!==t.reloadTime&&setTimeout(h.reloadComponent,t.reloadTime)};document.startViewTransition?document.startViewTransition(r).finished.then(o):(r(),o())}fetch(new URL(location.href),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";n(t)}).catch(e=>{t(e)})}).catch(e=>{t(e)})}static async __call(t,...n){const r=new URL(location.href),o=JSON.stringify({__call:{token:t,args:n}});try{const t=await fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(o)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await t.text();let a;if(n&&n.trim().startsWith("{"))try{a=JSON.parse(n),a=a?.response?JSON.parse(a.response):a}catch(e){a=n}else a=n||"";return a}catch(e){if(!e.response)return"";try{const t=await e.response.text();let n;try{n=t.trim().startsWith("{")?JSON.parse(t):t,n=n?.response?JSON.parse(n.response):n}catch(e){n=t}return n}catch{return""}}}}class f{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentState={};static events={beforeload:[],load:[]};static runAll(e){this.runInlineScripts(e),this.runInlineStyles(e),this.runPhpSpaScripts(e)}static runInlineScripts(t){const n=t.querySelectorAll("script"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedScripts.has(n)&&""!==t.textContent.trim()){this.executedScripts.add(n);const e=document.createElement("script");e.nonce=r;for(const n of t.attributes)e.setAttribute(n.name,n.value);const o=t.hasAttribute("async");e.textContent=o?`(async function() {\n${t.textContent}\n})();`:`(function() {\n${t.textContent}\n})();`,document.head.appendChild(e).remove()}})}static runPhpSpaScripts(e){e.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]').forEach(async e=>{const t=e.getAttribute("src"),n=document.documentElement.getAttribute("x-phpspa");if(!this.executedScripts.has(t)){if(this.executedScripts.add(t),this.ScriptsCachedContent[t]){const e=document.createElement("script");return e.textContent=this.ScriptsCachedContent[t],e.type="text/javascript",e.nonce=n,void document.head.appendChild(e).remove()}const e=await fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(e.ok){const r=await e.text(),o=document.createElement("script");o.textContent=r,o.type="text/javascript",o.nonce=n,document.head.appendChild(o).remove(),this.ScriptsCachedContent[t]=r}else console.error(`Failed to load script from ${t}: ${e.statusText}`)}})}static clearExecutedScripts(){f.executedScripts.clear()}static runInlineStyles(t){const n=t.querySelectorAll("style"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedStyles.has(n)&&""!==t.textContent.trim()){this.executedStyles.add(n);const e=document.createElement("style");e.nonce=r;for(const n of t.attributes)e.setAttribute(n.name,n.value);e.textContent=t.textContent,document.head.appendChild(e).remove()}})}static emit(e,t){const n=this.events[e]||[];for(const r of n)if("function"==typeof r)try{r(t)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static pushState(...e){try{history.pushState(...e)}catch(e){console.warn("Failed to push history state:",e.message)}}static replaceState(...e){try{history.replaceState(...e)}catch(e){console.warn("Failed to replace history state:",e.message)}}}return"undefined"!=typeof window&&"function"!=typeof window.setState&&(window.setState=function(e,t){return h.setState(e,t)}),"undefined"!=typeof window&&"function"!=typeof window.__call&&(window.__call=function(e,...t){return h.__call(e,...t)}),h});