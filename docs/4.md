## Handling Requests & Sessions

Your components often need to process incoming data, like form submissions or API calls. `PhpSPA` provides a clean, object-oriented way to access request data.

When a component is rendered, it can receive the current `Request` object as an argument.

### Accessing Request Data

The `Request` object is a powerful wrapper around PHP's superglobals (`$_POST`, `$_GET`, `$_FILES`, etc.), making your code cleaner and more secure.

Here’s how you would handle a form submission:

```php
<?php

use PhpSPA\Component;
use PhpSPA\Http\Request;

$loginPage = new Component(function (Request $request) {
   // Check if the form was submitted
   if ($request->isMethod('POST')) {
      $email = $request('email');
      $password = $request('password');

      // ... process login logic ...
   }

   // Display the login form
   echo <<<HTML
      <form method="POST">
         <input type="email" name="email" placeholder="Email">
         <input type="password" name="password" placeholder="Password">
         <button type="submit">Log In</button>
      </form>
   HTML;
});

$loginPage->route('/login')->method('GET|POST');
```

The `Request` object has many other useful methods:

  * `$request->get('key')`: Get a URL query parameter.
  * `$request->json('key')`: Get data from a JSON request body.
  * `$request->files('avatar')`: Access uploaded file data.
  * `$request->header('Authorization')`: Read a request header.
  * `$request->ip()`: Get the client's IP address.
  * `$request->isAjax()`: Check if it's an AJAX request.

### Redirects & Session Management

`PhpSPA` also includes helpers for common actions.

  * **Redirecting:** Use the global `Redirect()` function to send the user to a new page.
  * **Sessions:** Use the static `Session` class to manage user data across requests.

<!-- end list -->

```php
<?php

use PhpSPA\Http\Request;
use PhpSPA\Http\Session;
use function PhpSPA\Http\Redirect;

function handleLogin(Request $request) {
   $email = $request->post('email');
   // ... validate user ...

   if ($isValid) {
      Session::set('user_id', 123); // Log the user in
      Redirect('/dashboard');      // Send them to the dashboard
   }
}
```

### Content Security Policy (CSP)

For added security, you can easily enable a nonce-based Content Security Policy to protect against XSS attacks.

```php
<?php
use PhpSPA\Http\Security\Nonce;

// Enable CSP with a strict policy
Nonce::enable();

$nonce = Nonce::attr();

// In your layout, use the nonce attribute for your scripts
echo <<<HTML
   <script $nonce>
      /* ... */
   </script>
HTML;
```



=====================================



## Calling PHP from JavaScript (`useFunction`)

Often, you need to run PHP logic—like saving to a database—without a full page reload. The `useFunction` hook makes this simple without creating separate API routes.

It securely exposes a PHP function so your client-side JavaScript can call it directly.

### Example: A Simple Greeter Form

Let's build a form where a user enters their name, and the server sends back a personalized greeting.

```php
<?php

use phpSPA\Component;
use function Component\useFunction;

$greeterPage = new Component(function () {
    // 1. Define the PHP function you want to call.
    // It can accept arguments and should return the raw data.
    $sayHello = function (string $name): string {
        return "Hello, " . htmlspecialchars($name) . "!";
    };

    // 2. Wrap your function with useFunction().
    $greeter = useFunction($sayHello);

    echo <<<HTML
        <input type="text" id="nameInput" placeholder="Enter your name">
        <button id="greetBtn">Greet Me</button>

        <script>
            const nameInput = document.getElementById('nameInput');
            const greetBtn = document.getElementById('greetBtn');

            greetBtn.onclick = async () => {
                const name = nameInput.value;

                // 3. Call the PHP function from JavaScript!
                // The argument 'name' here is treated as a JavaScript expression.
                // It becomes the 'name' variable from the line above.
                const greeting = await {$greeter('name')};

                // The returned value is the direct output of your PHP function.
                alert(greeting); // Shows "Hello, [Name]!"
            };
        </script>
    HTML;
});

$greeterPage->route('/greeter');
```

### How It Works

When you echo the `$greeter('name')` object, it generates a JavaScript snippet like `phpspa.__call('some-secure-token', name)`. The arguments you pass to the caller in PHP are inserted directly as JavaScript expressions.

The `phpspa.js` library handles the secure AJAX request and returns the exact data from your PHP function (string, array, object, etc.) as a JavaScript promise.
