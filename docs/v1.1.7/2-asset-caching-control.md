# Asset Caching Control

Fine-grained control over asset caching duration and behavior in phpSPA v1.1.7

---

## Overview

The `assetCacheHours()` method provides precise control over how long browser and session-based assets are cached. This feature helps optimize performance by reducing redundant asset requests while maintaining flexibility for development and production environments.

## Key Features

### ‚è∞ Flexible Cache Duration
Set custom cache durations from session-only (0 hours) to long-term caching (days, weeks, or longer).

### üîÑ Dynamic Configuration
Change cache settings at runtime based on environment, user preferences, or application state.

### üéØ Performance Optimization
Reduce server load and improve page load times by leveraging browser caching effectively.

---

## Method Reference

### `App::assetCacheHours(int $hours): self`

Configures the cache duration for all assets (scripts and stylesheets) generated by the application.

**Parameters:**
- `$hours` (int): Number of hours to cache assets
  - `0`: Session-only caching (no persistent browser cache)
  - `1-8760`: Custom cache duration in hours (1 hour to 1 year)
  - Default: `24` hours (1 day)

**Returns:** `self` for method chaining

**HTTP Headers Set:**
- `Cache-Control: private, max-age={seconds}`
- `Content-Length: {asset_size}`

---

## Usage Examples

### Basic Configuration

```php
<?php
use phpSPA\App;

// Cache assets for 24 hours (default)
$app = new App('layout')->assetCacheHours(24);

// Cache assets for 1 week
$app = new App('layout')->assetCacheHours(168); // 24 * 7

// Session-only caching (no persistent cache)
$app = new App('layout')->assetCacheHours(0);
```

### Environment-Based Caching

```php
<?php
use phpSPA\App;

$app = new App('layout');

// Configure caching based on environment
if (getenv('APP_ENV') === 'production') {
    $app->assetCacheHours(168); // 1 week for production
} elseif (getenv('APP_ENV') === 'staging') {
    $app->assetCacheHours(24);  // 1 day for staging
} else {
    $app->assetCacheHours(1);   // 1 hour for development
}
```

### Dynamic Cache Configuration

```php
<?php
use phpSPA\App;

$app = new App('layout');

// Configure based on application version
$appVersion = '1.1.7';
$cacheHours = version_compare($appVersion, '1.1.0', '>=') ? 72 : 24;
$app->assetCacheHours($cacheHours);

// Or based on user preferences
$userSettings = getUserSettings();
$cacheStrategy = $userSettings['cache_preference'] ?? 'normal';

switch ($cacheStrategy) {
    case 'aggressive':
        $app->assetCacheHours(336); // 2 weeks
        break;
    case 'conservative':
        $app->assetCacheHours(6);   // 6 hours
        break;
    case 'session':
        $app->assetCacheHours(0);   // Session only
        break;
    default:
        $app->assetCacheHours(24);  // 1 day
}
```

### Method Chaining

```php
<?php
use phpSPA\App;

$app = new App('layout')
    ->assetCacheHours(48)  // Cache for 2 days
    ->script(function() {
        return "console.log('Cached script loaded');";
    })
    ->styleSheet(function() {
        return "body { font-family: Arial, sans-serif; }";
    });
```

---

## Cache Duration Guidelines

### Session-Only (0 hours)
**Use Case:** Development environment, debugging, frequently changing assets

```php
$app->assetCacheHours(0);
```

**Behavior:**
- Assets are cached only for the duration of the browser session
- Cache is cleared when browser is closed
- Forces fresh asset download on each session

**Best For:**
- Development and debugging
- Rapidly changing content
- User-specific or dynamic assets

### Short-Term (1-6 hours)
**Use Case:** Development, staging, frequently updated applications

```php
$app->assetCacheHours(3); // 3 hours
```

**Behavior:**
- Assets cached for a few hours
- Good balance between performance and freshness
- Allows for quick updates

**Best For:**
- Staging environments
- Applications with frequent updates
- Testing new features

### Medium-Term (24-72 hours)
**Use Case:** Production environments, stable applications

```php
$app->assetCacheHours(48); // 2 days
```

**Behavior:**
- Assets cached for 1-3 days
- Good performance with reasonable update frequency
- Standard for most web applications

**Best For:**
- Production applications
- Stable releases
- Balanced performance and update frequency

### Long-Term (168+ hours)
**Use Case:** Stable production, CDN usage, rarely changing assets

```php
$app->assetCacheHours(720); // 30 days
```

**Behavior:**
- Assets cached for weeks or months
- Maximum performance benefit
- Requires cache busting for updates

**Best For:**
- Very stable applications
- CDN distribution
- Assets that rarely change

---

## Cache Behavior Details

### Browser Cache Headers

When you set `assetCacheHours(24)`, the system generates these HTTP headers:

```http
Cache-Control: private, max-age=86400
Content-Type: text/css; charset=UTF-8
Content-Length: 1234
```

- `private`: Cache is specific to the user (not shared caches)
- `max-age=86400`: Cache for 86,400 seconds (24 hours)

### Session Integration

The caching system integrates with phpSPA's session management:

- **Asset mappings** are stored in the session
- **Cache configuration** persists across requests
- **Asset links** are generated based on session state

### Cache Validation

The system automatically handles cache validation by:

- Generating unique asset links for each component
- Including cache timestamps in session data
- Invalidating assets when cache duration expires

---

## Performance Impact

### Cache Hit Benefits
```
‚úÖ Reduced server load (assets served from browser cache)
‚úÖ Faster page load times (no network request for cached assets)
‚úÖ Lower bandwidth usage (smaller response sizes)
‚úÖ Better user experience (faster navigation)
```

### Cache Miss Handling
```
‚ö° Efficient asset generation (compressed content)
‚ö° Session-based asset links (no database queries)
‚ö° Optimized HTTP headers (proper cache directives)
‚ö° Automatic compression (reduced transfer size)
```

### Monitoring Cache Effectiveness

Monitor cache performance with browser dev tools:

```javascript
// Check cache status in browser console
performance.getEntriesByType('navigation')[0].transferSize;
performance.getEntriesByType('resource').forEach(resource => {
    console.log(resource.name, resource.transferSize === 0 ? 'CACHED' : 'DOWNLOADED');
});
```

---

## Best Practices

### üéØ Cache Duration Selection

**Development:**
```php
$app->assetCacheHours(0); // Session-only for rapid iteration
```

**Staging:**
```php
$app->assetCacheHours(6); // Short cache for testing
```

**Production:**
```php
$app->assetCacheHours(72); // Longer cache for performance
```

### üîÑ Update Strategies

**For Frequent Updates:**
- Use shorter cache durations (1-6 hours)
- Implement cache busting with version numbers
- Consider session-only caching for critical updates

**For Stable Releases:**
- Use longer cache durations (24-168 hours)
- Version your assets in the file content
- Monitor cache hit rates

### üöÄ Performance Optimization

**Combine with Compression:**
```php
$app = new App('layout')
    ->compression(Compressor::LEVEL_AGGRESSIVE, true)
    ->assetCacheHours(72);
```

**Use Environment Variables:**
```php
$cacheHours = (int) (getenv('ASSET_CACHE_HOURS') ?: 24);
$app->assetCacheHours($cacheHours);
```

### üîß Debugging Cache Issues

**Force Cache Refresh:**
```php
// Temporarily disable caching for debugging
if (isset($_GET['nocache'])) {
    $app->assetCacheHours(0);
}
```

**Log Cache Configuration:**
```php
$cacheConfig = AssetLinkManager::getCacheConfig();
error_log('Asset cache: ' . $cacheConfig['hours'] . ' hours');
```

---

## Integration Examples

### With Compression System

```php
<?php
use phpSPA\App;
use phpSPA\Compression\Compressor;

$app = new App('layout')
    ->compression(Compressor::LEVEL_EXTREME, true)
    ->assetCacheHours(168); // Long cache for compressed assets
```

### With Environment Detection

```php
<?php
use phpSPA\App;

$app = new App('layout');

// Auto-configure based on server environment
$isProduction = !empty($_SERVER['SERVER_NAME']) && 
                $_SERVER['SERVER_NAME'] !== 'localhost';

if ($isProduction) {
    $app->assetCacheHours(168); // 1 week
} else {
    $app->assetCacheHours(1);   // 1 hour for development
}
```

### With Dynamic Assets

```php
<?php
use phpSPA\App;

$app = new App('layout')
    ->assetCacheHours(24)
    ->script(function() {
        $config = json_encode([
            'version' => '1.1.7',
            'timestamp' => time(),
            'cache_hours' => AssetLinkManager::getCacheConfig()['hours']
        ]);
        
        return "window.APP_CONFIG = {$config};";
    });
```

This comprehensive caching system ensures optimal performance while maintaining the flexibility needed for different deployment scenarios and development workflows.
