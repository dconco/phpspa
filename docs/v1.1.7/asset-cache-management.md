# Asset Cache Management

Configure how long CSS and JavaScript assets are cached in phpSPA applications

---

## Overview

The `App::assetCacheHours()` method allows you to control the cache duration for CSS and JavaScript assets generated by your phpSPA application. This helps optimize performance while providing flexibility for different deployment scenarios.

## Basic Usage

### Set Cache Duration

```php
<?php
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(24) // Cache assets for 24 hours
    ->attach(require 'components/App.php')
    ->run();
```

### Session-Only Caching

```php
<?php
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(0) // No persistent caching, session-only
    ->attach(require 'components/App.php')
    ->run();
```

## Method Signature

```php
public function assetCacheHours(int $hours): self
```

**Parameters:**
- `$hours` (int): Number of hours to cache assets
  - `0`: Session-only caching (assets expire when session ends)
  - `> 0`: Cache for specified number of hours
  - Default without calling this method: 24 hours

**Returns:** The App instance for method chaining

## Caching Behavior

### Time-Based Caching (hours > 0)

When you set a positive number of hours:

```php
$app->assetCacheHours(12); // Cache for 12 hours
```

- Assets are cached with a timestamp
- Assets expire after the specified time
- Expired assets are automatically regenerated
- Cache persists across browser sessions

### Session-Only Caching (hours = 0)

When you set hours to 0:

```php
$app->assetCacheHours(0); // Session-only
```

- Assets are cached only for the current session
- Cache is cleared when the session ends
- Useful for development environments
- No persistent storage of asset mappings

## Use Cases

### Production Environment

```php
<?php
// Long-term caching for production
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(168) // Cache for 1 week (7 × 24 hours)
    ->attach(require 'components/App.php')
    ->run();
```

### Staging Environment

```php
<?php
// Moderate caching for staging
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(6) // Cache for 6 hours
    ->attach(require 'components/App.php')
    ->run();
```

### Development Environment

```php
<?php
// No persistent caching for development
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(0) // Session-only caching
    ->attach(require 'components/App.php')
    ->run();
```

## Environment-Based Configuration

You can conditionally set cache hours based on your environment:

```php
<?php
$cacheHours = match ($_ENV['APP_ENV'] ?? 'production') {
    'development' => 0,     // Session-only
    'staging'     => 6,     // 6 hours
    'production'  => 72,    // 3 days
    default       => 24     // 1 day
};

$app = (new App(require 'Layout.php'))
    ->assetCacheHours($cacheHours)
    ->attach(require 'components/App.php')
    ->run();
```

## How It Works

### Asset Hash Generation

phpSPA generates unique hashes for each CSS/JS asset:

1. **Hash Creation**: Based on component route, asset type, and timestamp
2. **Cache Storage**: Hash mappings stored in session with expiration data
3. **Cleanup**: Expired mappings are automatically removed

### Cache Validation

```php
// Internal cache validation logic
if ($cacheConfig['hours'] === 0) {
    // Session-only: never expires until session ends
    return false;
}

$expireTime = $mapping['created'] + ($cacheConfig['hours'] * 3600);
return time() > $expireTime;
```

## Performance Benefits

### Reduced Server Load

- Cached assets don't need regeneration
- Fewer file system operations
- Improved response times

### Optimized Memory Usage

- Automatic cleanup of expired assets
- Session-based storage for temporary caching
- Efficient hash-based asset identification

### Development Flexibility

- Session-only caching for immediate updates
- Time-based caching for production stability
- Environment-specific configurations

## Best Practices

### Choose Appropriate Cache Duration

```php
// ✅ Good: Environment-aware caching
$hours = $_ENV['APP_ENV'] === 'development' ? 0 : 24;
$app->assetCacheHours($hours);

// ❌ Avoid: Fixed long caching in development
$app->assetCacheHours(168); // Too long for development
```

### Consider Asset Update Frequency

```php
// ✅ Good: Frequent updates = shorter cache
$app->assetCacheHours(2); // For rapidly changing styles

// ✅ Good: Stable assets = longer cache
$app->assetCacheHours(72); // For stable production assets
```

### Method Chaining

```php
// ✅ Good: Use with other configuration methods
$app = (new App(require 'Layout.php'))
    ->assetCacheHours(24)
    ->compression(Compressor::LEVEL_AUTO, true)
    ->attach(require 'components/App.php')
    ->run();
```

## Troubleshooting

### Assets Not Updating

If you're seeing stale assets:

1. Check cache duration: `$app->assetCacheHours(0)` for immediate updates
2. Clear browser cache
3. Verify session is active

### Performance Issues

If caching isn't improving performance:

1. Increase cache duration for stable environments
2. Monitor cache hit rates
3. Consider using external caching solutions for high-traffic applications

---

**Next:** [Global Scripts and Styles](./global-scripts-and-styles.md) - Learn how to inject application-wide assets